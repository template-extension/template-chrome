<!DOCTYPE html>

<html>
<head>
  <title>background.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="analytics.html">
                analytics.coffee
              </a>
            
              
              <a class="source" href="background.html">
                background.coffee
              </a>
            
              
              <a class="source" href="content.html">
                content.coffee
              </a>
            
              
              <a class="source" href="i18n.html">
                i18n.coffee
              </a>
            
              
              <a class="source" href="install.html">
                install.coffee
              </a>
            
              
              <a class="source" href="log.html">
                log.coffee
              </a>
            
              
              <a class="source" href="notification.html">
                notification.coffee
              </a>
            
              
              <a class="source" href="options.html">
                options.coffee
              </a>
            
              
              <a class="source" href="popup.html">
                popup.coffee
              </a>
            
              
              <a class="source" href="store.html">
                store.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>background.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><a href="http://template-extension.org">Template</a><br>(c) 2013 Alasdair Mercer<br>Freely distributable under the MIT license:<br><a href="http://template-extension.org/license">http://template-extension.org/license</a></p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Private constants</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>List of blacklisted extension IDs that should be prevented from sending external messages to
Template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>BLACKLIST         = []</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Predefined templates to be used by default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>DEFAULT_TEMPLATES = [
  content:  <span class="string">'{url}'</span>
  enabled:  <span class="literal">yes</span>
  image:    <span class="string">'globe'</span>
  index:    <span class="number">0</span>
  key:      <span class="string">'PREDEFINED.00001'</span>
  readOnly: <span class="literal">yes</span>
  shortcut: <span class="string">'U'</span>
  title:    i18n.get <span class="string">'default_template_url'</span>
  usage:    <span class="number">0</span>
,
  content:  <span class="string">'{#shorten}{url}{/shorten}'</span>
  enabled:  <span class="literal">yes</span>
  image:    <span class="string">'tag'</span>
  index:    <span class="number">1</span>
  key:      <span class="string">'PREDEFINED.00002'</span>
  readOnly: <span class="literal">yes</span>
  shortcut: <span class="string">'S'</span>
  title:    i18n.get <span class="string">'default_template_short'</span>
  usage:    <span class="number">0</span>
,
  content:  <span class="string">"&lt;a href=\"{url}\"{#linksTarget} target=\"_blank\"{/linksTarget}{#linksTitle}
 title=\"{{title}}\"{/linksTitle}&gt;{{title}}&lt;/a&gt;"</span>
  enabled:  <span class="literal">yes</span>
  image:    <span class="string">'font'</span>
  index:    <span class="number">2</span>
  key:      <span class="string">'PREDEFINED.00003'</span>
  readOnly: <span class="literal">yes</span>
  shortcut: <span class="string">'A'</span>
  title:    i18n.get <span class="string">'default_template_anchor'</span>
  usage:    <span class="number">0</span>
,
  content:  <span class="string">'{#encode}{url}{/encode}'</span>
  enabled:  <span class="literal">yes</span>
  image:    <span class="string">'lock'</span>
  index:    <span class="number">3</span>
  key:      <span class="string">'PREDEFINED.00004'</span>
  readOnly: <span class="literal">yes</span>
  shortcut: <span class="string">'E'</span>
  title:    i18n.get <span class="string">'default_template_encoded'</span>
  usage:    <span class="number">0</span>
,
  content:  <span class="string">'[url={url}]{title}[/url]'</span>
  enabled:  <span class="literal">no</span>
  image:    <span class="string">'comment'</span>
  index:    <span class="number">5</span>
  key:      <span class="string">'PREDEFINED.00005'</span>
  readOnly: <span class="literal">yes</span>
  shortcut: <span class="string">'B'</span>
  title:    i18n.get <span class="string">'default_template_bbcode'</span>
  usage:    <span class="number">0</span>
,
  content:  <span class="string">'[{title}]({url}{#linksTitle} "{title}"{/linksTitle})'</span>
  enabled:  <span class="literal">no</span>
  image:    <span class="string">'asterisk'</span>
  index:    <span class="number">4</span>
  key:      <span class="string">'PREDEFINED.00006'</span>
  readOnly: <span class="literal">yes</span>
  shortcut: <span class="string">'M'</span>
  title:    i18n.get <span class="string">'default_template_markdown'</span>
  usage:    <span class="number">0</span>
,
  content:  <span class="string">'{selectionMarkdown}'</span>
  enabled:  <span class="literal">no</span>
  image:    <span class="string">'italic'</span>
  index:    <span class="number">6</span>
  key:      <span class="string">'PREDEFINED.00007'</span>
  readOnly: <span class="literal">yes</span>
  shortcut: <span class="string">'I'</span>
  title:    i18n.get <span class="string">'default_template_markdown_selection'</span>
  usage:    <span class="number">0</span>
]</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Extension ID being used by Template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EXTENSION_ID      = i18n.get <span class="string">'@@extension_id'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Domain of this extension&#39;s homepage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>HOMEPAGE_DOMAIN   = <span class="string">'template-extension.org'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>List of known operating systems that could be used by the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>OPERATING_SYSTEMS = [
  substring: <span class="string">'Win'</span>
  title:     <span class="string">'Windows'</span>
,
  substring: <span class="string">'Mac'</span>
  title:     <span class="string">'Mac'</span>
,
  substring: <span class="string">'Linux'</span>
  title:     <span class="string">'Linux'</span>
]</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Milliseconds before the popup automatically resets or closes, depending on user preferences.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>POPUP_DELAY       = <span class="number">600</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Regular expression used to extract useful information from different variations of names for tags
that are evaluated/executed later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>R_EXPRESSION_TAG  = <span class="regexp">/^(select|xpath)(all)?(\S*)?$/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Regular expression used to detect upper case characters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>R_UPPER_CASE      = <span class="regexp">/[A-Z]+/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Very primitive regular expression used to perform simple URL validation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>R_VALID_URL       = <span class="regexp">/^https?:\/\/\S+\.\S+/i</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Extension ID of the production version of Template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>REAL_EXTENSION_ID = <span class="string">'dcjnfaoifoefmnbhhlbppaebgnccfddf'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>List of URL shortener services supported by Template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>SHORTENERS        = [</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Setup <a href="http://bit.ly">bitly</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  name: <span class="string">'bitly'</span>
  title: i18n.get <span class="string">'shortener_bitly'</span>
  method: <span class="string">'GET'</span>

  getHeaders: -&gt;
    <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>

  getParameters: (url) -&gt;
    params =
      format:  <span class="string">'json'</span>
      longUrl: url
    <span class="keyword">if</span> <span class="property">@oauth</span>.hasAccessToken()
      params.access_token = <span class="property">@oauth</span>.getAccessToken()
    <span class="keyword">else</span>
      params.apiKey = ext.config.services.bitly.api_key
      params.login  = ext.config.services.bitly.login
    params

  getUsage: -&gt;
    store.get <span class="string">'bitly.usage'</span>

  input: -&gt;
    <span class="literal">null</span>

  isEnabled: -&gt;
    store.get <span class="string">'bitly.enabled'</span>

  oauth: -&gt;
    options = _.pick ext.config.services.bitly, <span class="string">'client_id'</span>, <span class="string">'client_secret'</span>
    <span class="keyword">new</span> OAuth2 <span class="string">'bitly'</span>, options

  output: (resp) -&gt;
    JSON.parse(resp).data.url

  url: -&gt;
    ext.config.services.bitly.url
,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Setup <a href="http://goo.gl">Google URL Shortener</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  name: <span class="string">'googl'</span>
  title: i18n.get <span class="string">'shortener_googl'</span>
  method: <span class="string">'POST'</span>

  getHeaders: -&gt;
    headers = <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>
    headers.Authorization = <span class="string">"OAuth <span class="subst">#{@oauth.getAccessToken()}</span>"</span> <span class="keyword">if</span> <span class="property">@oauth</span>.hasAccessToken()
    headers

  getParameters: -&gt;
    <span class="keyword">unless</span> <span class="property">@oauth</span>.hasAccessToken()
      key: ext.config.services.googl.api_key

  getUsage: -&gt;
    store.get <span class="string">'googl.usage'</span>

  input: (url) -&gt;
    JSON.stringify longUrl: url

  isEnabled: -&gt;
    store.get <span class="string">'googl.enabled'</span>

  oauth: -&gt;
    options = _.pick ext.config.services.googl, <span class="string">'api_scope'</span>, <span class="string">'client_id'</span>, <span class="string">'client_secret'</span>
    <span class="keyword">new</span> OAuth2 <span class="string">'google'</span>, options

  output: (resp) -&gt;
    JSON.parse(resp).id

  url: -&gt;
    ext.config.services.googl.url
,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Setup <a href="http://yourls.org">YOURLS</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  name: <span class="string">'yourls'</span>
  title: i18n.get <span class="string">'shortener_yourls'</span>
  method: <span class="string">'POST'</span>

  getHeaders: -&gt;
    <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>

  getParameters: (url) -&gt;
    params =
      action: <span class="string">'shorturl'</span>
      format: <span class="string">'json'</span>
      url:    url

    {authentication, password, signature, username} = store.get <span class="string">'yourls'</span>
    <span class="keyword">switch</span> authentication
      <span class="keyword">when</span> <span class="string">'advanced'</span>
        params.signature = signature <span class="keyword">if</span> signature
      <span class="keyword">when</span> <span class="string">'basic'</span>
        params.password  = password  <span class="keyword">if</span> password
        params.username  = username  <span class="keyword">if</span> username

    params

  getUsage: -&gt;
    store.get <span class="string">'yourls.usage'</span>

  input: -&gt;
    <span class="literal">null</span>

  isEnabled: -&gt;
    store.get <span class="string">'yourls.enabled'</span>

  output: (resp) -&gt;
    JSON.parse(resp).shorturl

  url: -&gt;
    store.get <span class="string">'yourls.url'</span>
]</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>List of extensions supported by Template and used for compatibility purposes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>SUPPORT           =</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Setup <a href="http://ietab.net">IE Tab</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hehijbfgiekmjfkfjpbkbammjbdenadd: (tab) -&gt;
    <span class="keyword">if</span> tab.title
      str       = <span class="string">'IE: '</span>
      idx       = tab.title.indexOf str
      tab.title = tab.title.substring idx + str.length <span class="keyword">if</span> idx <span class="keyword">isnt</span> -<span class="number">1</span>

    <span class="keyword">if</span> tab.url
      str     = <span class="string">'iecontainer.html#url='</span>
      idx     = tab.url.indexOf str
      tab.url = decodeURIComponent tab.url.substring idx + str.length <span class="keyword">if</span> idx <span class="keyword">isnt</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Setup <a href="http://goo.gl/u7Cau">IE Tab Classic</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  miedgcmlgpmdagojnnbemlkgidepfjfi: (tab) -&gt;
    <span class="keyword">if</span> tab.url
      str     = <span class="string">'ie.html#'</span>
      idx     = tab.url.indexOf str
      tab.url = tab.url.substring idx + str.length <span class="keyword">if</span> idx <span class="keyword">isnt</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Setup <a href="http://iblogbox.com/chrome/ietab">IE Tab Multi (Enhance)</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fnfnbeppfinmnjnjhedifcfllpcfgeea: (tab) -&gt;
    <span class="keyword">if</span> tab.url
      str = <span class="string">'navigate.html?chromeurl='</span>
      idx = tab.url.indexOf str
      <span class="keyword">if</span> idx <span class="keyword">isnt</span> -<span class="number">1</span>
        tab.url = tab.url.substring idx + str.length
        str     = <span class="string">'[escape]'</span>
        tab.url = decodeURIComponent tab.url[str.length..] <span class="keyword">unless</span> tab.url.indexOf str</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Setup <a href="http://iblogbox.com/chrome/geckotab">Mozilla Gecko Tab</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  icoloanbecehinobmflpeglknkplbfbm: (tab) -&gt;
    <span class="keyword">if</span> tab.url
      str = <span class="string">'navigate.html?chromeurl='</span>
      idx = tab.url.indexOf str
      <span class="keyword">if</span> idx <span class="keyword">isnt</span> -<span class="number">1</span>
        tab.url = tab.url.substring idx + str.length
        str     = <span class="string">'[escape]'</span>
        tab.url = decodeURIComponent tab.url[str.length..] <span class="keyword">unless</span> tab.url.indexOf str</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Used by Chrome to represent an unknown language (i.e. one that it couldn&#39;t detect).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>UNKNOWN_LOCALE    = <span class="string">'und'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2>Private variables</h2>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Details of the current browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>browser           =
  title:   <span class="string">'Chrome'</span>
  version: <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Indicate whether or not Template has just been installed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>isNewInstall      = <span class="literal">no</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Indicate whether or not Template is currently running the production build.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>isProductionBuild = EXTENSION_ID <span class="keyword">is</span> REAL_EXTENSION_ID</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Name of the user&#39;s operating system.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>operatingSystem   = <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2>Private functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Inject and execute the <code>content.coffee</code> and <code>install.coffee</code> scripts within all of the tabs
(where valid) of each Chrome window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">executeScriptsInExistingWindows</span></span> = -&gt;
  log.trace()

  chrome.tabs.query {}, (tabs) -&gt;
    log.info <span class="string">'Checking the following tabs for content script execution...'</span>, tabs</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Check tabs are not displaying a <em>protected</em> page (i.e. one that will cause an error if an
attempt is made to execute content scripts).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> tab <span class="keyword">in</span> tabs <span class="keyword">when</span> <span class="keyword">not</span> isProtectedPage tab
      chrome.tabs.executeScript tab.id, file: <span class="string">'lib/content.js'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Only execute inline installation content script for tabs displaying a page on Template&#39;s
homepage domain.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.tabs.executeScript tab.id, file: <span class="string">'lib/install.js'</span> <span class="keyword">if</span> HOMEPAGE_DOMAIN <span class="keyword">in</span> tab.url</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Attempt to derive the current version of the user&#39;s browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getBrowserVersion</span></span> = -&gt;
  log.trace()

  str = navigator.userAgent
  idx = str.indexOf browser.title
  <span class="keyword">if</span> idx <span class="keyword">isnt</span> -<span class="number">1</span>
    str = str.substring idx + browser.title.length + <span class="number">1</span>
    idx = str.indexOf <span class="string">' '</span>
    <span class="keyword">if</span> idx <span class="keyword">is</span> -<span class="number">1</span> <span class="keyword">then</span> str <span class="keyword">else</span> str[<span class="number">0.</span>..idx]</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Build a list of shortcuts used by enabled templates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getHotkeys</span></span> = -&gt;
  log.trace()

  template.shortcut <span class="keyword">for</span> template <span class="keyword">in</span> ext.templates <span class="keyword">when</span> template.enabled</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Derive the operating system being used by the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getOperatingSystem</span></span> = -&gt;
  log.trace()

  <span class="keyword">return</span> os.title <span class="keyword">for</span> os <span class="keyword">in</span> OPERATING_SYSTEMS <span class="keyword">when</span> os.substring <span class="keyword">in</span> navigator.platform
  navigator.platform</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Attempt to retrieve the template with the specified <code>key</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getTemplateWithKey</span></span> = (key) -&gt;
  log.trace()

  _.findWhere ext.templates, {key}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Attempt to retrieve the template with the specified <code>menuId</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getTemplateWithMenuId</span></span> = (menuId) -&gt;
  log.trace()

  _.findWhere ext.templates, {menuId}</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Attempt to retrieve the template with the specified keyboard <code>shortcut</code>.<br>Exclude disabled templates from this query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getTemplateWithShortcut</span></span> = (shortcut) -&gt;
  log.trace()

  _.findWhere ext.templates, {enabled: <span class="literal">yes</span>, shortcut}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Determine whether or not the identified extension is blacklisted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">isBlacklisted</span></span> = (extensionId) -&gt;
  log.trace()

  <span class="keyword">return</span> <span class="literal">yes</span> <span class="keyword">for</span> extension <span class="keyword">in</span> BLACKLIST <span class="keyword">when</span> extension <span class="keyword">is</span> extensionId
  <span class="literal">no</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Determine whether or not the specified extension is active on <code>tab</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">isExtensionActive</span></span> = (tab, extensionId) -&gt;
  log.trace()

  log.debug <span class="string">"Checking activity of supported extension '<span class="subst">#{extensionId}</span>'"</span>

  isSpecialPage(tab) <span class="keyword">and</span> extensionId <span class="keyword">in</span> tab.url</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Determine whether or not <code>tab</code> is currently displaying a <em>protected</em> page (i.e. a page that
content scripts cannot be executed on).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">isProtectedPage</span></span> = (tab) -&gt;
  log.trace()

  isSpecialPage(tab) <span class="keyword">or</span> isWebStore tab</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Determine whether or not <code>tab</code> is currently displaying a <em>special</em> page (i.e. a page that is
internal to the browser).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">isSpecialPage</span></span> = (tab) -&gt;
  log.trace()

  <span class="keyword">not</span> tab.url.indexOf <span class="string">'chrome'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Determine whether or not <code>tab</code> is currently displaying a page on the Chrome Web Store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">isWebStore</span></span> = (tab) -&gt;
  log.trace()

  <span class="keyword">not</span> tab.url.indexOf <span class="string">'https://chrome.google.com/webstore'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Ensure <code>null</code> is returned instead of <code>object</code> if it is <em>empty</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">nullIfEmpty</span></span> = (object) -&gt;
  log.trace()

  <span class="keyword">if</span> _.isEmpty object <span class="keyword">then</span> <span class="literal">null</span> <span class="keyword">else</span> object</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Listener for internal messages sent to the extension.<br>External messages are also routed through here, but only after being checked that they do not
originate from a blacklisted extension.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">onMessage</span></span> = (message, sender, sendResponse) -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Safely handle callback functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  callback = utils.callback sendResponse</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Message type is required. Informal rejection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> <span class="keyword">do</span> callback <span class="keyword">unless</span> message.type</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Don&#39;t allow shortcut requests when shortcuts are disabled.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> <span class="keyword">do</span> callback <span class="keyword">if</span> message.type <span class="keyword">is</span> <span class="string">'shortcut'</span> <span class="keyword">and</span> <span class="keyword">not</span> store.get <span class="string">'shortcuts.enabled'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Select or create a tab for the Options page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> message.type <span class="keyword">is</span> <span class="string">'options'</span>
    selectOrCreateTab utils.url <span class="string">'pages/options.html'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Close the popup if it&#39;s currently open. This <em>should</em> happen naturally but is being forced to
ensure consistency.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    chrome.extension.getViews(type: <span class="string">'popup'</span>)[<span class="number">0</span>]?.close()
    <span class="keyword">return</span> <span class="keyword">do</span> callback</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Info requests are simple, just send some useful information back. Done!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> message.type <span class="keyword">in</span> [<span class="string">'info'</span>, <span class="string">'version'</span>]
    <span class="keyword">return</span> callback
      hotkeys: <span class="keyword">do</span> getHotkeys
      id:      EXTENSION_ID
      version: ext.version</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Variables to maintain the various states for this request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  active       = data   = output   = template = <span class="literal">null</span>
  editable     = link   = shortcut = <span class="literal">no</span>
  id           = utils.keyGen <span class="string">''</span>, <span class="literal">null</span>, <span class="string">'t'</span>, <span class="literal">no</span>
  placeholders = {}

  async.series [
    (done) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Find the active tab within the current window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.tabs.query {active: <span class="literal">yes</span>, currentWindow: <span class="literal">yes</span>}, (tabs) -&gt;
        log.debug <span class="string">'Checking the following tabs for the active tab...'</span>, tabs
        active = _.first tabs
        <span class="keyword">do</span> done

    (done) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Return a callback function to be used by a tag to indicate that it requires further
action.<br>Replace the tag with the unique placeholder so that it can be rendered again later with the
final value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="title">getCallback</span></span> = (tag) -&gt;
        (text, render) -&gt;
          text = render text <span class="keyword">if</span> text
          text = <span class="property">@url</span>        <span class="keyword">if</span> tag <span class="keyword">is</span> <span class="string">'shorten'</span> <span class="keyword">and</span> <span class="keyword">not</span> text
          trim = text?.trim() <span class="keyword">or</span> <span class="string">''</span>
          log.debug <span class="string">"Following is the contents of a <span class="subst">#{tag}</span> tag..."</span>, text</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>If <code>trim</code> doesn&#39;t appear to be a valid so just return the rendered <code>text</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">return</span> text <span class="keyword">if</span> <span class="keyword">not</span> trim <span class="keyword">or</span> tag <span class="keyword">is</span> <span class="string">'shorten'</span> <span class="keyword">and</span> <span class="keyword">not</span> R_VALID_URL.test trim</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Search for existing placeholder to improve performance later down the line (e.g.
multiple URL shortener requests for the same URL).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">for</span> own key, val <span class="keyword">of</span> placeholders
            <span class="keyword">if</span> val.data <span class="keyword">is</span> trim <span class="keyword">and</span> val.tag <span class="keyword">is</span> tag
              placeholder = key
              <span class="keyword">break</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Ensure the placeholder is stored correctly for later use.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">unless</span> placeholder?
            placeholder = utils.keyGen <span class="string">''</span>, <span class="literal">null</span>, <span class="string">'c'</span>, <span class="literal">no</span>
            placeholders[placeholder] = {data: trim, tag}</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Sections are re-rendered so the context must have a property for the placeholder the
replaces itself with itself so that it still when it comes to replacing with the
final value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>[placeholder] = <span class="string">"{<span class="subst">#{placeholder}</span>}"</span>

          log.debug <span class="string">"Replacing <span class="subst">#{tag}</span> tag with <span class="subst">#{placeholder}</span> placeholder"</span>
          <span class="string">"{<span class="subst">#{placeholder}</span>}"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>If the popup is currently displayed, hide the template list and show a loading animation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      updateProgress <span class="literal">null</span>, <span class="literal">yes</span>

      <span class="keyword">try</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Attempt to derive the contextual template data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        template = deriveMessageTempate message
        updateProgress <span class="number">10</span>

        {data, editable, link, shortcut} = deriveMessageInfo message, active, getCallback
        updateProgress <span class="number">20</span>

        <span class="keyword">do</span> done
      <span class="keyword">catch</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Oops! Something went wrong so we should probably let the user know.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        log.error err

        <span class="keyword">if</span> err <span class="keyword">instanceof</span> AppError
          done err
        <span class="keyword">else</span>
          done <span class="keyword">new</span> AppError <span class="keyword">if</span> err <span class="keyword">instanceof</span> URIError
            <span class="string">'result_bad_uri_description'</span>
          <span class="keyword">else</span>
            <span class="string">'result_bad_error_description'</span>

    (done) -&gt;
      updateProgress <span class="number">30</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Extract additional data from the environment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      addAdditionalData active, data, id, editable, shortcut, link, -&gt;
        updateProgress <span class="number">40</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>To complete the data, simply extend it using <code>template</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $.extend <span class="literal">yes</span>, data, {template}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Ensure all properties of <code>data</code> are lower case.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transformData data
        log.debug <span class="string">"Using the following data to render <span class="subst">#{template.title}</span>..."</span>, data</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Render the initial template output based on <code>data</code>.<br>This <em>may</em> be rendered again to replace any temporary placeholders that were inserted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> template.content
          output = Mustache.render template.content, data
          log.debug <span class="string">'The following was generated as a result...'</span>, output

        updateProgress <span class="number">60</span>
        output ?= <span class="string">''</span>

        <span class="keyword">do</span> done

    (done) -&gt;
      updateProgress <span class="number">70</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Only proceed if any placeholders were inserted and replaced, as they need to be handled now
in order to replace any placeholders with their final values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="keyword">do</span> done <span class="keyword">if</span> _.isEmpty placeholders</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Maps to populated with relevant data derived from their related stored placeholders.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expressionMap = {}
      shortenMap    = {}

      <span class="keyword">for</span> own placeholder, info <span class="keyword">of</span> placeholders
        <span class="keyword">if</span> info.tag <span class="keyword">is</span> <span class="string">'shorten'</span>
          shortenMap[placeholder] = info.data
        <span class="keyword">else</span>
          match = info.tag.match R_EXPRESSION_TAG
          <span class="keyword">if</span> match
            expressionMap[placeholder] =
              all:        match[<span class="number">2</span>]?
              convertTo:  match[<span class="number">3</span>]
              expression: info.data
              type:       match[<span class="number">1</span>]

      async.series [
        (done) -&gt;
          updateProgress <span class="number">80</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Only proceed if any expression (e.g. <em>select</em>, <em>xpath</em>) placeholders were used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">return</span> <span class="keyword">do</span> done <span class="keyword">if</span> _.isEmpty expressionMap</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Evaluate all of the expressions within the <code>active</code> tab and update <code>expressionMap</code> with
the results.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          evaluateExpressions active, expressionMap, (err) -&gt;
            updateProgress <span class="number">85</span>

            <span class="keyword">unless</span> err
              log.info <span class="string">"<span class="subst">#{_.size expressionMap}</span> expression(s) were evaluated"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Update the corresponding placeholders with their result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              placeholders[placeholder] = value <span class="keyword">for</span> own placeholder, value <span class="keyword">of</span> expressionMap

            done err

        (done) -&gt;
          updateProgress <span class="number">90</span></pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Only proceed if any URL shortener placeholders were used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">return</span> <span class="keyword">do</span> done <span class="keyword">if</span> _.isEmpty shortenMap</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Call the active URL shortener service for each of the placeholders.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          callUrlShortener shortenMap, (err, response) -&gt;
            updateProgress <span class="number">95</span>

            <span class="keyword">unless</span> err
              log.info <span class="string">"URL shortener service was called <span class="subst">#{_.size shortenMap}</span> time(s)"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Update the URL shortener service&#39;s usage to ensure captured statistics are
accurate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              updateUrlShortenerUsage response.service.name, response.oauth</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Update the corresponding placeholders with their result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              placeholders[placeholder] = value <span class="keyword">for</span> own placeholder, value <span class="keyword">of</span> shortenMap

            done err

      ], (err) -&gt;
        <span class="keyword">unless</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Request(s) were successful so render the output again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          output = Mustache.render output, placeholders
          log.debug <span class="string">'The follow was re-generated as a result...'</span>, output

        done err

  ], (err) -&gt;
    updateProgress <span class="number">100</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Transform message type into a more user-friendly form.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    type = utils.capitalize message.type

    analytics.track <span class="string">'Requests'</span>, <span class="string">'Processed'</span>, type, <span class="keyword">if</span> shortcut <span class="keyword">then</span> message.data.key.charCodeAt <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Ensure that the user is notified if they have attempted to copy an empty string to the system
clipboard.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="keyword">not</span> err <span class="keyword">and</span> <span class="keyword">not</span> output
      err = <span class="keyword">new</span> AppError <span class="string">'result_bad_empty_description'</span>, template.title

    notification = ext.notification

    <span class="keyword">if</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Notify the user that an error occurred while processing the copy request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      log.warn err.message

      notification.title       = i18n.get <span class="string">'result_bad_title'</span>
      notification.titleStyle  = <span class="string">'color: #B94A48'</span>
      notification.description = err.message ? i18n.get <span class="string">'result_bad_description'</span>, template.title

      <span class="keyword">do</span> showNotification
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Update the activated template&#39;s usage to ensure captured statistics accurate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      updateTemplateUsage template.key
      <span class="keyword">do</span> updateStatistics</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Notify the user that the copy request was successful once it has been completed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      notification.title       = i18n.get <span class="string">'result_good_title'</span>
      notification.titleStyle  = <span class="string">'color: #468847'</span>
      notification.description = i18n.get <span class="string">'result_good_description'</span>, template.title

      ext.copy output</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Finally, allow the copied content to be <em>pasted</em> into a field on the active tab.<br>This action is dependant on whether the page is <em>protected</em>, the relevant option is
enabled, and that a field was within the context of the template&#39;s activation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> <span class="keyword">not</span> isProtectedPage(active) <span class="keyword">and</span> (editable <span class="keyword">and</span> store.get <span class="string">'menu.paste'</span>) <span class="keyword">or</span>
          (shortcut <span class="keyword">and</span> store.get <span class="string">'shortcuts.paste'</span>)
        chrome.tabs.sendMessage active.id, {contents: output, id, type: <span class="string">'paste'</span>}

    log.debug <span class="string">"Finished handling a <span class="subst">#{type}</span> request"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Listener for external messages sent to the extension.<br>Only messages sent from extensions/apps that have not been previously blacklisted routed to
<code>onMessage</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">onMessageExternal</span></span> = (message, sender, sendResponse) -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Safely handle callback functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  callback = utils.callback sendResponse</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Ensure blacklisted extensions/apps are blocked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  blocked = isBlacklisted sender.id

  analytics.track <span class="string">'External Requests'</span>, <span class="string">'Started'</span>, sender.id, Number !blocked

  <span class="keyword">if</span> blocked
    log.debug <span class="string">"Blocked external request from <span class="subst">#{sender.id}</span>"</span>
    <span class="keyword">return</span> <span class="keyword">do</span> callback

  log.debug <span class="string">"Accepted external request from <span class="subst">#{sender.id}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Route message as if it was sent internally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onMessage message, sender, sendResponse</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Attempt to select a tab in the current window displaying a page whose location begins with
<code>url</code>.<br>If no existing tab exists a new one is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">selectOrCreateTab</span></span> = (url, callback) -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Retrieve the tabs of last focused window to check for an existing one with a <em>matching</em> URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  chrome.windows.getLastFocused populate: <span class="literal">yes</span>, (win) -&gt;
    {tabs} = win

    log.debug <span class="string">'Checking the tabs of the following last focused window...'</span>, win
    log.debug <span class="string">'Checking the following tabs for a matching URL...'</span>, tabs</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Try to find an existing tab that begins with <code>url</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> tab <span class="keyword">in</span> tabs <span class="keyword">when</span> <span class="keyword">not</span> tab.url.indexOf url
      existing = tab
      <span class="keyword">break</span>

    <span class="keyword">if</span> existing?</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Found one! Now to select it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.tabs.update existing.id, active: <span class="literal">yes</span>
      callback? existing
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Ach well, let&#39;s just create a brand-spanking new one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.tabs.create {windowId: win.id, url, active: <span class="literal">yes</span>}, (tab) -&gt;
        callback? tab</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Display a desktop notification informing the user on whether or not the copy request was
successful.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">showNotification</span></span> = -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Ensure that <code>ext</code> is <em>reset</em> and that a notification is only displayed if the user has enabled
the corresponding option (enabled by default).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> store.get <span class="string">'notifications.enabled'</span>
    webkitNotifications.createHTMLNotification(utils.url <span class="string">'pages/notification.html'</span>).show()
  <span class="keyword">else</span>
    ext.reset()</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Reset and hide any visible progress bar on the popup, where possible.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updateProgress <span class="literal">null</span>, <span class="literal">no</span></pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Convert the <code>html</code> into Markdown using <a href="http://neocotic.com/html.md">html.md</a> while ensuring
related options are used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">toMarkdown</span></span> = (html) -&gt;
  log.trace()

  {inline} = store.get <span class="string">'markdown'</span>

  md html, {inline}</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Update hotkeys stored by the <code>content.coffee</code> script within all of the tabs (where valid) of each
Chrome window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">updateHotkeys</span></span> = -&gt;
  log.trace()

  hotkeys = <span class="keyword">do</span> getHotkeys</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Retrieve all open tabs (on all windows) and update their registered keyboard shortcuts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  chrome.tabs.query {}, (tabs) -&gt;
    log.info <span class="string">'Updating the hotkeys registed in the following tabs...'</span>, tabs</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Check tabs are not displaying a <em>protected</em> page (i.e. one that will cause an error if an
attempt is made to send a message to it).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> tab <span class="keyword">in</span> tabs <span class="keyword">when</span> <span class="keyword">not</span> isProtectedPage tab
      chrome.tabs.sendMessage tab.id, {hotkeys}</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Update the popup UI state to reflect the progress of the current request.<br>Ignore <code>percent</code> if <code>toggle</code> is specified; otherwise update the percentage on the progress bar
and reset the delay timer.<br><code>toggle</code> can be used to show the progress bar or reset/close the popup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">updateProgress</span></span> = (percent, toggle) -&gt;
  log.trace()

  popup       = $ chrome.extension.getViews(type: <span class="string">'popup'</span>)[<span class="number">0</span>]
  templates   = <span class="keyword">if</span> popup.length <span class="keyword">then</span> $ <span class="string">'#templates'</span>, popup[<span class="number">0</span>].document <span class="keyword">else</span> $()
  loading     = <span class="keyword">if</span> popup.length <span class="keyword">then</span> $ <span class="string">'#loading'</span>,   popup[<span class="number">0</span>].document <span class="keyword">else</span> $()
  progressBar = loading.find <span class="string">'.bar'</span>

  <span class="keyword">if</span> toggle?
    <span class="keyword">if</span> toggle</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Reset the progress bar to zero and ensure it&#39;s visible while the templates are hidden.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      progressBar.css <span class="string">'width'</span>, <span class="string">'0%'</span>
      popup.delay            POPUP_DELAY
      templates.hide().delay POPUP_DELAY
      loading.show().delay   POPUP_DELAY
    <span class="keyword">else</span>
      <span class="keyword">if</span> store.get <span class="string">'toolbar.close'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Close the popup, where possible.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        popup.queue -&gt;
          popup.dequeue()[<span class="number">0</span>]?.close()
      <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Reset the progress bar to zero and ensure it&#39;s hidden while the templates are visibile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        loading.queue -&gt;
          loading.hide().dequeue()
          progressBar.css <span class="string">'width'</span>, <span class="string">'0%'</span>
        templates.queue -&gt;
          templates.show().dequeue()
  <span class="keyword">else</span> <span class="keyword">if</span> percent?</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Update the progress bar to display the specified <code>percent</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    log.info <span class="string">"Updating bar progress to <span class="subst">#{percent}</span>%"</span>

    popup.dequeue().delay     POPUP_DELAY
    templates.dequeue().delay POPUP_DELAY
    loading.dequeue().delay   POPUP_DELAY
    progressBar.css <span class="string">'width'</span>, <span class="string">"<span class="subst">#{percent}</span>%"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Update the statistical information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">updateStatistics</span></span> = -&gt;
  log.trace()

  log.info <span class="string">'Updating statistics'</span>

  store.init <span class="string">'stats'</span>, {}
  store.modify <span class="string">'stats'</span>, (stats) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Determine which template has the greatest usage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    popular = _.max ext.templates, (template) -&gt;
      template.usage</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Calculate the up-to-date statistical information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stats.count       = ext.templates.length
    stats.customCount = stats.count - DEFAULT_TEMPLATES.length
    stats.popular     = popular?.key</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Increment the usage for the template with the specified <code>key</code> and persist the changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">updateTemplateUsage</span></span> = (key) -&gt;
  log.trace()

  template = _.findWhere ext.templates, {key}

  <span class="keyword">if</span> template?
    template.usage++
    store.set <span class="string">'templates'</span>, ext.templates

    log.info <span class="string">"Used the <span class="subst">#{template.title}</span> template"</span>
    analytics.track <span class="string">'Templates'</span>, <span class="string">'Used'</span>, template.title, Number template.readOnly</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Increment the usage for the URL shortener service with the specified <code>name</code> and persist the
changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">updateUrlShortenerUsage</span></span> = (name, oauth) -&gt;
  log.trace()

  shortener = _.findWhere SHORTENERS, {name}

  <span class="keyword">if</span> shortener?
    store.modify name, (shortener) -&gt;
      shortener.usage++

    log.info <span class="string">"Used the <span class="subst">#{shortener.title}</span> URL shortener"</span>
    analytics.track <span class="string">'Shorteners'</span>, <span class="string">'Used'</span>, shortener.title, Number oauth</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <h2>Errors</h2>

            </div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p><code>AppError</code> allows easy identification of internal errors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">AppError</span> <span class="keyword">extends</span> <span class="title">Error</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Create a new instance of <code>AppError</code> with a localized message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (messageKey, substitutions...) -&gt;
    <span class="property">@message</span> = i18n.get messageKey, substitutions <span class="keyword">if</span> messageKey</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <h2>Data functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Extract additional information from <code>tab</code> and add it to <code>data</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">addAdditionalData</span></span> = (tab, data, id, editable, shortcut, link, callback) -&gt;
  log.trace()

  async.parallel [
    (done) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Retrieve all of the URLs from tabs contained in the same window as <code>tab</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.tabs.query windowId: tab.windowId, (tabs) -&gt;
        log.debug <span class="string">'Extracting the URLs from the following tabs...'</span>,   tabs

        tabs = _.pluck tabs, <span class="string">'url'</span>

        done <span class="literal">null</span>, {tabs}

    (done) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Allow Chrome to attemt automatic language detection on <code>tab</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.tabs.detectLanguage tab.id, (locale) -&gt;
        log.debug <span class="string">"Chrome automatically detected language: <span class="subst">#{locale}</span>"</span>

        locale = <span class="string">''</span> <span class="keyword">unless</span> locale <span class="keyword">and</span> locale <span class="keyword">isnt</span> UNKNOWN_LOCALE

        done <span class="literal">null</span>, {locale}

    (done) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Retrieve the geolocation from the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      navigator.geolocation.getCurrentPosition (position) -&gt;
        log.debug <span class="string">'Retrieved the following geolocation information...'</span>, position

        done <span class="literal">null</span>, coords: transformData position.coords, <span class="literal">yes</span>
      , (err) -&gt;
        log.warn <span class="string">'Ingoring error thrown when calculating geolocation'</span>, err.message

        done <span class="literal">null</span>, coords: {}

    (done) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Retrieve all of the cookies the client has stored for the contextual URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.cookies.getAll url: data.url, (cookies) -&gt;
        log.debug <span class="string">'Found the following cookies...'</span>, cookies

        done <span class="literal">null</span>,
          cookie: -&gt;
            (text, render) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Attempt to find the value for the cookie name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              name   = render text
              cookie = _.findWhere cookies, {name}

              cookie?.value <span class="keyword">or</span> <span class="string">''</span>
          cookies: _.chain(cookies).pluck(<span class="string">'name'</span>).uniq().value()

    (done) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Try to prevent pages hanging because content script should not have been executed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="keyword">do</span> done <span class="keyword">if</span> isProtectedPage tab</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Call the content script running within <code>tab</code> and request additional data to be extracted
from the page&#39;s DOM.<br>The content script also takes this oppertunity to prepare for a second request that may
potentially be sent later instructing it to paste the result of this copy request into a
field within the context of the template&#39;s activation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.tabs.sendMessage tab.id, {editable, id, link, shortcut, url: data.url}, (response) -&gt;
        log.debug <span class="string">'The following data was retrieved from the content script...'</span>, response</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Safety mechanism for when content scripts haven&#39;t been updated along with the extension
so the request gets stuck. This is mainly an issue in development and not production.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        response ?= {}</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Attempt to transform <code>lastModified</code> into a usable date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        lastModified = <span class="keyword">if</span> response.lastModified?
          time = Date.parse response.lastModified
          <span class="keyword">new</span> Date time <span class="keyword">unless</span> isNaN time</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Sanitize the <code>response</code> so that it&#39;s data can be cleanly integrated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        done <span class="literal">null</span>,
          author:         response.author         ? <span class="string">''</span>
          characterset:   response.characterSet   ? <span class="string">''</span>
          description:    response.description    ? <span class="string">''</span>
          images:         response.images         ? []
          keywords:       response.keywords       ? []
          lastmodified:   -&gt;
            (text, render) -&gt;
              lastModified?.format(render(text) <span class="keyword">or</span> <span class="literal">undefined</span>) ? <span class="string">''</span>
          linkhtml:       response.linkHTML       ? <span class="string">''</span>
          links:          response.links          ? []
          linktext:       response.linkText       ? <span class="string">''</span>
          localstorage:   response.localStorage   ? {}
          pageheight:     response.pageHeight     ? <span class="string">''</span>
          pagewidth:      response.pageWidth      ? <span class="string">''</span>
          referrer:       response.referrer       ? <span class="string">''</span>
          scripts:        response.scripts        ? []
          selectedimages: response.selectedImages ? []
          selectedlinks:  response.selectedLinks  ? []
          selection:      response.selection      ? <span class="string">''</span>
          selectionhtml:  response.selectionHTML  ? <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>selectedLinks</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          selectionlinks: -&gt;
            <span class="property">@selectedlinks</span>
          sessionstorage: response.sessionStorage ? {}
          stylesheets:    response.styleSheets    ? []

  ], (err, results = []) -&gt;
    log.error err <span class="keyword">if</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Extend the original <code>data</code> with any additional data that was retrieved successfully.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.extend data, result <span class="keyword">for</span> result <span class="keyword">in</span> results <span class="keyword">when</span> result?

    <span class="keyword">do</span> callback</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Creates an object containing data based on information derived from the specified tab and menu
item data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">buildDerivedData</span></span> = (tab, onClickData, getCallback) -&gt;
  log.trace()

  info    = editable: onClickData.editable, link: <span class="literal">no</span>
  fakeTab =
    title: tab.title
    url:   <span class="keyword">if</span> onClickData.linkUrl
        info.link = <span class="literal">yes</span>
        onClickData.linkUrl
      <span class="keyword">else</span> <span class="keyword">if</span> onClickData.srcUrl   <span class="keyword">then</span> onClickData.srcUrl
      <span class="keyword">else</span> <span class="keyword">if</span> onClickData.frameUrl <span class="keyword">then</span> onClickData.frameUrl
      <span class="keyword">else</span> onClickData.pageUrl
  info.data = buildStandardData fakeTab, getCallback

  info</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Construct a data object based on information extracted from <code>tab</code>.<br>The tab information is then merged with additional information relating to the URL of the tab.<br>If a tag requires further action (e.g. call a URL shortening service) when parsing the templates
contents later, the callback method returned by <code>getCallback</code> is called to handle this as we
don&#39;t want to perform these expensive tasks unless it is actually required.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">buildStandardData</span></span> = (tab, getCallback) -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Create a clone of the original tab of the tab to run the compatibility scripts on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ctab = $.extend {}, tab</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Check for any support extensions running on the current tab by simply checking the tabs URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> own extension, handler <span class="keyword">of</span> SUPPORT <span class="keyword">when</span> isExtensionActive tab, extension
    log.debug <span class="string">"Making data compatible with <span class="subst">#{extension}</span>"</span>

    handler? ctab
    <span class="keyword">break</span></pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Build the initial URL data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  data = {}
  url  = $.url ctab.url</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Create references to the base of all grouped options to improve lookup performance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bitly         = store.get <span class="string">'bitly'</span>
  googl         = store.get <span class="string">'googl'</span>
  links         = store.get <span class="string">'links'</span>
  markdown      = store.get <span class="string">'markdown'</span>
  menu          = store.get <span class="string">'menu'</span>
  notifications = store.get <span class="string">'notifications'</span>
  shortcuts     = store.get <span class="string">'shortcuts'</span>
  stats         = store.get <span class="string">'stats'</span>
  toolbar       = store.get <span class="string">'toolbar'</span>
  yourls        = store.get <span class="string">'yourls'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Merge the initial data with the attributes of the <a href="https://github.com/allmarkedup/jQuery-URL-Parser">URL
parser</a> and all of the custom Template
properties.<br>All properties should be in lower case so that they can be looked up ignoring case by our
modified version of <a href="https://github.com/janl/mustache.js">mustache.js</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.extend data, url.attr(),</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Deprecated since 1.2.5, use <code>linkstarget</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    anchortarget:          -&gt;
      <span class="property">@linkstarget</span></pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Deprecated since 1.2.5, use <code>linkstitle</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    anchortitle:           -&gt;
      <span class="property">@linkstitle</span>
    bitly:                 bitly.enabled
    bitlyaccount:          -&gt;
      _.findWhere(SHORTENERS, name: <span class="string">'bitly'</span>).oauth.hasAccessToken()
    browser:               browser.title
    browserversion:        browser.version
    capitalise:            -&gt;
      <span class="keyword">do</span> <span class="property">@capitalize</span>
    capitalize:            -&gt;
      (text, render) -&gt;
        utils.capitalize render text</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>menu</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    contextmenu:           -&gt;
      <span class="property">@menu</span>
    cookiesenabled:        navigator.cookieEnabled
    count:                 stats.count
    customcount:           stats.customCount
    datetime:              -&gt;
      (text, render) -&gt;
        <span class="keyword">new</span> Date().format(render(text) <span class="keyword">or</span> <span class="literal">undefined</span>) ? <span class="string">''</span>
    decode:                -&gt;
      (text, render) -&gt;
        decodeURIComponent(render text) ? <span class="string">''</span>
    depth:                 screen.colorDepth</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>linkstarget</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    doanchortarget:        -&gt;
      <span class="property">@linkstarget</span></pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>linkstitle</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    doanchortitle:         -&gt;
      <span class="property">@linkstitle</span>
    encode:                -&gt;
      (text, render) -&gt;
        encodeURIComponent(render text) ? <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Deprecated since 0.1.0.2, use <code>encode</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    encoded:               -&gt;
      encodeURIComponent <span class="property">@url</span>
    escape:                -&gt;
      (text, render) -&gt;
        _.escape render text
    favicon:               ctab.favIconUrl
    fparam:                -&gt;
      (text, render) -&gt;
        url.fparam(render text) ? <span class="string">''</span>
    fparams:               nullIfEmpty url.fparam()
    fsegment:              -&gt;
      (text, render) -&gt;
        url.fsegment(parseInt render(text), <span class="number">10</span>) ? <span class="string">''</span>
    fsegments:             url.fsegment()
    googl:                 googl.enabled
    googlaccount:          -&gt;
      _.findWhere(SHORTENERS, name: <span class="string">'googl'</span>).oauth.hasAccessToken()</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>googlaccount</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    googloauth:            -&gt;
      <span class="keyword">do</span> <span class="property">@googlaccount</span>
    java:                  navigator.javaEnabled()
    length:                -&gt;
      (text, render) -&gt;
        render(text).length
    linkmarkdown:          -&gt;
      toMarkdown <span class="property">@linkhtml</span>
    linkstarget:           links.target
    linkstitle:            links.title
    lowercase:             -&gt;
      (text, render) -&gt;
        render(text).toLowerCase()
    markdowninline:        markdown.inline
    menu:                  menu.enabled
    menuoptions:           menu.options
    menupaste:             menu.paste
    notifications:         notifications.enabled
    notificationduration:  notifications.duration * <span class="number">.001</span>
    offline:               <span class="keyword">not</span> navigator.onLine</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Deprecated since 0.1.0.2, use <code>originalurl</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    originalsource:        -&gt;
      <span class="property">@originalurl</span>
    originaltitle:         tab.title <span class="keyword">or</span> url.attr <span class="string">'source'</span>
    originalurl:           tab.url
    os:                    operatingSystem
    param:                 -&gt;
      (text, render) -&gt;
        url.param(render text) ? <span class="string">''</span>
    params:                nullIfEmpty url.param()
    plugins:               _.chain(navigator.plugins).pluck(<span class="string">'name'</span>).uniq().value()
    popular:               $.extend <span class="literal">yes</span>, {}, _.findWhere ext.templates, key: stats.popular
    screenheight:          screen.height
    screenwidth:           screen.width
    segment:               -&gt;
      (text, render) -&gt;
        url.segment(parseInt render(text), <span class="number">10</span>) ? <span class="string">''</span>
    segments:              url.segment()
    select:                -&gt;
      getCallback <span class="string">'select'</span>
    selectall:             -&gt;
      getCallback <span class="string">'selectall'</span>
    selectallhtml:         -&gt;
      getCallback <span class="string">'selectallhtml'</span>
    selectallmarkdown:     -&gt;
      getCallback <span class="string">'selectallmarkdown'</span>
    selecthtml:            -&gt;
      getCallback <span class="string">'selecthtml'</span>
    selectionmarkdown:     -&gt;
      toMarkdown <span class="property">@selectionhtml</span>
    selectmarkdown:        -&gt;
      getCallback <span class="string">'selectmarkdown'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>shorten</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    short:                 -&gt;
      <span class="keyword">do</span> <span class="property">@shorten</span>
    shortcuts:             shortcuts.enabled
    shortcutspaste:        shortcuts.paste
    shorten:               -&gt;
      getCallback <span class="string">'shorten'</span>
    tidy:                  -&gt;
      (text, render) -&gt;
        render(text).replace(<span class="regexp">/([ \t]+)/g</span>, <span class="string">' '</span>).trim()
    title:                 ctab.title <span class="keyword">or</span> url.attr <span class="string">'source'</span>
    toolbarclose:          toolbar.close</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use the inverse of <code>toolbarpopup</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toolbarfeature:        -&gt;
      <span class="keyword">not</span> <span class="property">@toolbarpopup</span></pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>toolbarstyle</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toolbarfeaturedetails: -&gt;
      <span class="property">@toolbarstyle</span></pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>Deprecated since 1.0.0, use <code>toolbarkey</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toolbarfeaturename:    -&gt;
      <span class="property">@toolbarkey</span>
    toolbarkey:            toolbar.key
    toolbaroptions:        toolbar.options
    toolbarpopup:          toolbar.popup</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>Obsolete since 1.1.0, functionality has been removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toolbarstyle:          <span class="literal">no</span>
    trim:                  -&gt;
      (text, render) -&gt;
        render(text).trim()
    trimleft:              -&gt;
      (text, render) -&gt;
        render(text).trimLeft()
    trimright:             -&gt;
      (text, render) -&gt;
        render(text).trimRight()
    unescape:              -&gt;
      (text, render) -&gt;
        _.unescape render text
    uppercase:             -&gt;
      (text, render) -&gt;
        render(text).toUpperCase()
    url:                   url.attr <span class="string">'source'</span>
    version:               ext.version
    xpath:                -&gt;
      getCallback <span class="string">'xpath'</span>
    xpathall:             -&gt;
      getCallback <span class="string">'xpathall'</span>
    xpathallhtml:         -&gt;
      getCallback <span class="string">'xpathallhtml'</span>
    xpathallmarkdown:     -&gt;
      getCallback <span class="string">'xpathallmarkdown'</span>
    xpathhtml:            -&gt;
      getCallback <span class="string">'xpathhtml'</span>
    xpathmarkdown:        -&gt;
      getCallback <span class="string">'xpathmarkdown'</span>
    yourls:                yourls.enabled
    yourlsauthentication:  yourls.authentication
    yourlspassword:        yourls.password
    yourlssignature:       yourls.signature
    yourlsurl:             yourls.url
    yourlsusername:        yourls.username

  data</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Derive the relevant information, including the template data, based on both <code>message</code> and <code>tab</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">deriveMessageInfo</span></span> = (message, tab, getCallback) -&gt;
  log.trace()

  info =
    data:     <span class="literal">null</span>
    editable: <span class="literal">no</span>
    link:     <span class="literal">no</span>
    shortcut: <span class="literal">no</span>

  $.extend info, <span class="keyword">switch</span> message.type
    <span class="keyword">when</span> <span class="string">'menu'</span>
      buildDerivedData tab, message.data, getCallback
    <span class="keyword">when</span> <span class="string">'popup'</span>, <span class="string">'toolbar'</span>
      data: buildStandardData tab, getCallback
    <span class="keyword">when</span> <span class="string">'shortcut'</span>
      data:     buildStandardData tab, getCallback
      shortcut: <span class="literal">yes</span>
    <span class="keyword">else</span>
      <span class="keyword">throw</span> <span class="keyword">new</span> AppError <span class="string">'result_bad_type_description'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Derive the relevant template based on the context of <code>message</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">deriveMessageTempate</span></span> = (message) -&gt;
  log.trace()

  template = <span class="keyword">switch</span> message.type
    <span class="keyword">when</span> <span class="string">'menu'</span>             <span class="keyword">then</span> getTemplateWithMenuId message.data.menuItemId
    <span class="keyword">when</span> <span class="string">'popup'</span>, <span class="string">'toolbar'</span> <span class="keyword">then</span> getTemplateWithKey message.data.key
    <span class="keyword">when</span> <span class="string">'shortcut'</span>         <span class="keyword">then</span> getTemplateWithShortcut message.data.key
    <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> AppError <span class="string">'result_bad_type_description'</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> AppError <span class="string">'result_bad_template_description'</span> <span class="keyword">unless</span> template?

  template</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Evaluate the expressions in <code>map</code> within the content scripts in <code>tab</code> in order to obtain their
corresponding values.<br>Expressions can be of mixed type (i.e. CSS selector, XPath expression) and contain different
instructions depending on the tag that was used by the user.<br><code>callback</code> will be called with the result once all of the expressions have been evaluated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">evaluateExpressions</span></span> = (tab, map, callback) -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>Since content scripts cannot be executed on <em>protected</em> pages attempting to send a message to
one would result in background errors being thrown, so we&#39;ll just have to make sure the
placeholder is removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> isProtectedPage tab
    map[placeholder] = <span class="string">''</span> <span class="keyword">for</span> own placeholder <span class="keyword">of</span> map
    <span class="keyword">return</span> <span class="keyword">do</span> callback</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Tell the content script in <code>tab</code> to evaluate all of the expressions in <code>map</code> and update it with
their corresponding values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  chrome.tabs.sendMessage tab.id, expressions: map, (response) -&gt;
    log.debug <span class="string">'The following response was returned by the content script...'</span>, response

    response ?= {}

    <span class="keyword">for</span> own placeholder, expression <span class="keyword">of</span> response.expressions
      {convertTo, error, result} = expression

      <span class="keyword">break</span> <span class="keyword">if</span> error

      result <span class="keyword">or</span>= <span class="string">''</span>
      result   = result.join <span class="string">'\n'</span> <span class="keyword">if</span> _.isArray result
      result   = toMarkdown result <span class="keyword">if</span> convertTo <span class="keyword">is</span> <span class="string">'markdown'</span>

      map[placeholder] = result

    callback <span class="keyword">if</span> error <span class="keyword">then</span> <span class="keyword">new</span> AppError <span class="string">'result_bad_expression_description'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Ensure there is a lower case variant of all properties of <code>data</code>, optionally only changing a
clone of the specified <code>data</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">transformData</span></span> = (data, clone) -&gt;
  log.trace()

  <span class="keyword">return</span> data <span class="keyword">unless</span> data</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Ensure that the <code>result</code> and <code>data</code> types match when cloning.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  result = <span class="keyword">if</span> clone
    <span class="keyword">if</span> _.isArray data <span class="keyword">then</span> [] <span class="keyword">else</span> {}
  <span class="keyword">else</span>
    data

  <span class="function"><span class="title">transform</span></span> = (value) -&gt;
    <span class="keyword">if</span> _.isArray(value) <span class="keyword">or</span> _.isObject(value) <span class="keyword">then</span> transformData value, clone <span class="keyword">else</span> value

  <span class="keyword">if</span> _.isArray result</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Also transform any nested objects deep within the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    result[i] = transform value <span class="keyword">for</span> value, i <span class="keyword">in</span> data
  <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Transform all properties of the object, included any deep nested objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> own prop, value <span class="keyword">of</span> data
      prop = prop.toLowerCase() <span class="keyword">if</span> clone <span class="keyword">or</span> R_UPPER_CASE.test prop

      result[prop] = transform value

  result</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <h2>Configuration functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Transform specific sections of the data loaded from <code>configuration.json</code> so that they&#39;re more
usable and localized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">buildConfig</span></span> = -&gt;
  log.trace()

  <span class="keyword">do</span> buildIcons</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Transform the configuration icons into usable <code>Icon</code> instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">buildIcons</span></span> = -&gt;
  log.trace()

  <span class="keyword">for</span> name, i <span class="keyword">in</span> ext.config.icons.current
    ext.config.icons.current[i] = <span class="keyword">new</span> Icon name</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <h2>HTML building functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>Build the HTML to populate the popup with to optimize popup loading times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">buildPopup</span></span> = -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Generate the HTML for each enabled template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  items = $()
  items = items.add buildTemplate template <span class="keyword">for</span> template <span class="keyword">in</span> ext.templates <span class="keyword">when</span> template.enabled</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>Add a generic message to state the obvious... that the list is empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">unless</span> items.length
    message = <span class="string">" <span class="subst">#{i18n.get 'empty'}</span>"</span>
    items   = items.add $(<span class="string">'&lt;li/&gt;'</span>, class: <span class="string">'empty'</span>).append($ <span class="string">'&lt;i/&gt;'</span>, class: <span class="string">'icon-'</span>).append message</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Add a link to the options page if the user doesn&#39;t mind.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> store.get <span class="string">'toolbar.options'</span>
    anchor = $ <span class="string">'&lt;a/&gt;'</span>,
      class:       <span class="string">'options'</span>
      <span class="string">'data-type'</span>: <span class="string">'options'</span>
    anchor.append $ <span class="string">'&lt;i/&gt;'</span>, class: Icon.get(<span class="string">'cog'</span>).style
    anchor.append <span class="string">" <span class="subst">#{i18n.get 'options'}</span>"</span>

    items = items.add $ <span class="string">'&lt;li/&gt;'</span>, class: <span class="string">'divider'</span>
    items = items.add $(<span class="string">'&lt;li/&gt;'</span>).append anchor

  ext.templatesHtml = $(<span class="string">'&lt;div/&gt;'</span>).append(items).html()</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Create an <code>li</code> element to represent <code>template</code>.<br>The element should then be inserted in to the <code>ul</code> element in the popup page but is created here
to optimize display times for the popup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">buildTemplate</span></span> = (template) -&gt;
  log.trace()

  log.debug <span class="string">"Creating popup list item for the <span class="subst">#{template.title}</span> template"</span>

  anchor = $ <span class="string">'&lt;a/&gt;'</span>,
    <span class="string">'data-key'</span>:  template.key
    <span class="string">'data-type'</span>: <span class="string">'popup'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>Ensure keyboard shortcuts are displayed correctly, where appropriate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> template.shortcut <span class="keyword">and</span> store.get <span class="string">'shortcuts.enabled'</span>
    anchor.append $ <span class="string">'&lt;span/&gt;'</span>,
      class: <span class="string">'pull-right'</span>,
      html:  <span class="string">"<span class="subst">#{ext.modifiers()}</span><span class="subst">#{template.shortcut}</span>"</span>

  anchor.append $ <span class="string">'&lt;i/&gt;'</span>, class: Icon.get(template.image, <span class="literal">yes</span>).style
  anchor.append <span class="string">" <span class="subst">#{template.title}</span>"</span>

  $(<span class="string">'&lt;li/&gt;'</span>).append anchor</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <h2>Initialization functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have been stored previously
by <code>ext.init</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">init_update</span></span> = -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>Update the update progress indicator itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> store.exists <span class="string">'update_progress'</span>
    store.modify <span class="string">'updates'</span>, (updates) -&gt;
      <span class="keyword">for</span> own namespace, versions <span class="keyword">of</span> store.remove <span class="string">'update_progress'</span>
        updates[namespace] = <span class="keyword">if</span> versions?.length <span class="keyword">then</span> versions.pop() <span class="keyword">else</span> <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>Create an updater for the <code>settings</code> namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updater      = <span class="keyword">new</span> store.Updater <span class="string">'settings'</span>
  updater.<span class="literal">on</span> <span class="string">'update'</span>, (version) -&gt;
    log.info <span class="string">"Updating general settings for <span class="subst">#{version}</span>"</span>

  isNewInstall = updater.isNew</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Define the processes for all required updates to the <code>settings</code> namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updater.update <span class="string">'0.1.0.0'</span>, -&gt;
    store.rename <span class="string">'settingNotification'</span>,      <span class="string">'notifications'</span>,        <span class="literal">on</span>
    store.rename <span class="string">'settingNotificationTimer'</span>, <span class="string">'notificationDuration'</span>, <span class="number">3000</span>
    store.rename <span class="string">'settingShortcut'</span>,          <span class="string">'shortcuts'</span>,            <span class="literal">on</span>
    store.rename <span class="string">'settingTargetAttr'</span>,        <span class="string">'doAnchorTarget'</span>,       <span class="literal">off</span>
    store.rename <span class="string">'settingTitleAttr'</span>,         <span class="string">'doAnchorTitle'</span>,        <span class="literal">off</span>
    store.remove <span class="string">'settingIeTabExtract'</span>,      <span class="string">'settingIeTabTitle'</span>

  updater.update <span class="string">'1.0.0'</span>, -&gt;
    <span class="keyword">if</span> store.exists <span class="string">'options_active_tab'</span>
      optionsActiveTab = store.get <span class="string">'options_active_tab'</span>
      store.set <span class="string">'options_active_tab'</span>, <span class="keyword">switch</span> optionsActiveTab
        <span class="keyword">when</span> <span class="string">'features_nav'</span> <span class="keyword">then</span> <span class="string">'templates_nav'</span>
        <span class="keyword">when</span> <span class="string">'toolbar_nav'</span> <span class="keyword">then</span> <span class="string">'general_nav'</span>
        <span class="keyword">else</span> optionsActiveTab

    store.modify <span class="string">'links'</span>, (links) -&gt;
      links.target = store.get(<span class="string">'doAnchorTarget'</span>) ? <span class="literal">off</span>
      links.title  = store.get(<span class="string">'doAnchorTitle'</span>)  ? <span class="literal">off</span>
    store.remove <span class="string">'doAnchorTarget'</span>, <span class="string">'doAnchorTitle'</span>

    store.modify <span class="string">'menu'</span>, (menu) -&gt;
      menu.enabled = store.get(<span class="string">'contextMenu'</span>) ? <span class="literal">yes</span>
    store.remove <span class="string">'contextMenu'</span>

    store.set <span class="string">'notifications'</span>,
      duration: store.get(<span class="string">'notificationDuration'</span>) ? <span class="number">3000</span>
      enabled:  store.get(<span class="string">'notifications'</span>)        ? <span class="literal">yes</span>
    store.remove <span class="string">'notificationDuration'</span>

  updater.update <span class="string">'1.1.0'</span>, -&gt;
    store.set <span class="string">'shortcuts'</span>, enabled: store.get(<span class="string">'shortcuts'</span>) ? <span class="literal">yes</span>

  updater.update <span class="string">'1.2.3'</span>, -&gt;
    store.modify <span class="string">'logger'</span>, (logger) -&gt;
      <span class="keyword">delete</span> logger.Enabled
      <span class="keyword">delete</span> logger.Level

    store.modify <span class="string">'menu'</span>, (menu) -&gt;
      <span class="keyword">delete</span> menu.Enabled
      <span class="keyword">delete</span> menu.Options
      <span class="keyword">delete</span> menu.Paste

    store.modify <span class="string">'notifications'</span>, (notifications) -&gt;
      <span class="keyword">delete</span> notifications.Duration
      <span class="keyword">delete</span> notifications.Enabled

    store.modify <span class="string">'shortcuts'</span>, (shortcuts) -&gt;
      <span class="keyword">delete</span> shortcuts.Enabled
      <span class="keyword">delete</span> shortcuts.Paste

    store.modify <span class="string">'toolbar'</span>, (toolbar) -&gt;
      <span class="keyword">delete</span> toolbar.Close
      <span class="keyword">delete</span> toolbar.Key
      <span class="keyword">delete</span> toolbar.Options

  updater.update <span class="string">'1.2.5'</span>, -&gt;
    store.modify <span class="string">'links'</span>, (links) -&gt;
      anchor = store.get(<span class="string">'anchor'</span>) ? {}
      links.target = anchor.target ? <span class="literal">off</span>
      links.title  = anchor.title  ? <span class="literal">off</span>
    store.remove <span class="string">'anchor'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>Initialize the settings related to statistical information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initStatistics</span></span> = -&gt;
  log.trace()

  <span class="keyword">do</span> updateStatistics</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>Initialize <code>template</code> and its properties, before adding it to <code>templates</code> to be persisted later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initTemplate</span></span> = (template, templates) -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Derive the index of <code>template</code> to determine whether or not it already exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  idx = templates.indexOf _.findWhere templates, key: template.key

  <span class="keyword">if</span> idx <span class="keyword">is</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p><code>template</code> doesn&#39;t already exist so add it now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    log.debug <span class="string">'Adding the following predefined template...'</span>, template

    templates.push template
  <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p><code>template</code> exists so modify the properties to ensure they are reliable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    log.debug <span class="string">'Ensuring following template adheres to structure...'</span>, template

    <span class="keyword">if</span> template.readOnly</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p><code>template</code> is read-only so certain properties should always be overriden and others only
when they are not already available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      templates[idx].content   = template.content
      templates[idx].enabled  ?= template.enabled
      templates[idx].image    ?= template.image
      templates[idx].index    ?= template.index
      templates[idx].key       = template.key
      templates[idx].readOnly  = <span class="literal">yes</span>
      templates[idx].shortcut ?= template.shortcut
      templates[idx].title     = template.title
      templates[idx].usage    ?= template.usage
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p><code>template</code> is <em>not</em> read-only so set unavailable, but required, properties to their default
value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      templates[idx].content  ?= <span class="string">''</span>
      templates[idx].enabled  ?= <span class="literal">yes</span>
      templates[idx].image    ?= <span class="string">''</span>
      templates[idx].index    ?= <span class="number">0</span>
      templates[idx].key      ?= template.key
      templates[idx].readOnly  = <span class="literal">no</span>
      templates[idx].shortcut ?= <span class="string">''</span>
      templates[idx].title    ?= <span class="string">'?'</span>
      templates[idx].usage    ?= <span class="number">0</span>

    template = templates[idx]

  template</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Initialize the persisted managed templates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initTemplates</span></span> = -&gt;
  log.trace()

  <span class="keyword">do</span> initTemplates_update

  store.modify <span class="string">'templates'</span>, (templates) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Initialize all default templates to ensure their properties are as expected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initTemplate template, templates <span class="keyword">for</span> template <span class="keyword">in</span> DEFAULT_TEMPLATES</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Now, initialize <em>all</em> templates to ensure their properties are valid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initTemplate template, templates <span class="keyword">for</span> template <span class="keyword">in</span> templates

  ext.updateTemplates()</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have been stored previously
by <code>initTemplates</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initTemplates_update</span></span> = -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>Create updater for the <code>features</code> namespace and then rename it to <code>templates</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updater = <span class="keyword">new</span> store.Updater <span class="string">'features'</span>
  updater.<span class="literal">on</span> <span class="string">'update'</span>, (version) -&gt;
    log.info <span class="string">"Updating template settings for <span class="subst">#{version}</span>"</span>
  updater.rename <span class="string">'templates'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>Define the processes for all required updates to the <code>templates</code> namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updater.update <span class="string">'0.1.0.0'</span>, -&gt;
    store.rename <span class="string">'copyAnchorEnabled'</span>,  <span class="string">'feat__anchor_enabled'</span>,  <span class="literal">yes</span>
    store.rename <span class="string">'copyAnchorOrder'</span>,    <span class="string">'feat__anchor_index'</span>,    <span class="number">2</span>
    store.rename <span class="string">'copyBBCodeEnabled'</span>,  <span class="string">'feat__bbcode_enabled'</span>,  <span class="literal">no</span>
    store.rename <span class="string">'copyBBCodeOrder'</span>,    <span class="string">'feat__bbcode_index'</span>,    <span class="number">4</span>
    store.rename <span class="string">'copyEncodedEnabled'</span>, <span class="string">'feat__encoded_enabled'</span>, <span class="literal">yes</span>
    store.rename <span class="string">'copyEncodedOrder'</span>,   <span class="string">'feat__encoded_index'</span>,   <span class="number">3</span>
    store.rename <span class="string">'copyShortEnabled'</span>,   <span class="string">'feat__short_enabled'</span>,   <span class="literal">yes</span>
    store.rename <span class="string">'copyShortOrder'</span>,     <span class="string">'feat__short_index'</span>,     <span class="number">1</span>
    store.rename <span class="string">'copyUrlEnabled'</span>,     <span class="string">'feat__url_enabled'</span>,     <span class="literal">yes</span>
    store.rename <span class="string">'copyUrlOrder'</span>,       <span class="string">'feat__url_index'</span>,       <span class="number">0</span>

  updater.update <span class="string">'0.2.0.0'</span>, -&gt;
    names = store.get(<span class="string">'features'</span>) ? []

    <span class="keyword">for</span> name <span class="keyword">in</span> names <span class="keyword">when</span> _.isString name
      store.rename <span class="string">"feat_<span class="subst">#{name}</span>_template"</span>, <span class="string">"feat_<span class="subst">#{name}</span>_content"</span>

      image = store.get <span class="string">"feat_<span class="subst">#{name}</span>_image"</span>

      <span class="keyword">if</span> _.isString image
        <span class="keyword">if</span> image <span class="keyword">in</span> [<span class="string">''</span>, <span class="string">'spacer.gif'</span>, <span class="string">'spacer.png'</span>]
          store.set <span class="string">"feat_<span class="subst">#{name}</span>_image"</span>, <span class="number">0</span>
        <span class="keyword">else</span>
          <span class="keyword">for</span> legacy, i <span class="keyword">in</span> ext.config.icons.legacy
            <span class="keyword">if</span> <span class="string">"<span class="subst">#{legacy.name.replace /^tmpl/, 'feat'}</span>.png"</span> <span class="keyword">is</span> image
              store.set <span class="string">"feat_<span class="subst">#{name}</span>_image"</span>, i + <span class="number">1</span>
              <span class="keyword">break</span>
      <span class="keyword">else</span>
        store.set <span class="string">"feat_<span class="subst">#{name}</span>_image"</span>, <span class="number">0</span>

  updater.update <span class="string">'1.0.0'</span>, -&gt;
    names              = store.remove(<span class="string">'features'</span>) ? []
    templates          = []

    toolbarFeatureName = store.get <span class="string">'toolbarFeatureName'</span>

    <span class="keyword">for</span> name <span class="keyword">in</span> names <span class="keyword">when</span> _.isString name
      image = store.remove(<span class="string">"feat_<span class="subst">#{name}</span>_image"</span>) ? <span class="number">0</span>
      image = <span class="keyword">if</span> --image &gt;= <span class="number">0</span> <span class="keyword">then</span> Icon.fromLegacy(image)?.name <span class="keyword">or</span> <span class="string">''</span> <span class="keyword">else</span> <span class="string">''</span>

      key = ext.getKeyForName name

      <span class="keyword">if</span> toolbarFeatureName <span class="keyword">is</span> name
        <span class="keyword">if</span> store.exists <span class="string">'toolbar'</span>
          store.modify <span class="string">'toolbar'</span>, (toolbar) -&gt;
            toolbar.key = key
        <span class="keyword">else</span>
          store.set <span class="string">'toolbar'</span>, key: key

      templates.push
        content:  store.remove(<span class="string">"feat_<span class="subst">#{name}</span>_content"</span>)  ? <span class="string">''</span>
        enabled:  store.remove(<span class="string">"feat_<span class="subst">#{name}</span>_enabled"</span>)  ? <span class="literal">yes</span>
        image:    image
        index:    store.remove(<span class="string">"feat_<span class="subst">#{name}</span>_index"</span>)    ? <span class="number">0</span>
        key:      key
        readOnly: store.remove(<span class="string">"feat_<span class="subst">#{name}</span>_readonly"</span>) ? <span class="literal">no</span>
        shortcut: store.remove(<span class="string">"feat_<span class="subst">#{name}</span>_shortcut"</span>) ? <span class="string">''</span>
        title:    store.remove(<span class="string">"feat_<span class="subst">#{name}</span>_title"</span>)    ? <span class="string">'?'</span>
        usage:    <span class="number">0</span>

    store.set <span class="string">'templates'</span>, templates
    store.remove store.search(<span class="regexp">/^feat_.*_(content|enabled|image|index|readonly|shortcut|title)$/</span>)...

  updater.update <span class="string">'1.1.0'</span>, -&gt;
    store.modify <span class="string">'templates'</span>, (templates) -&gt;
      <span class="keyword">for</span> template <span class="keyword">in</span> templates
        <span class="keyword">if</span> template.readOnly
          <span class="keyword">break</span> <span class="keyword">for</span> base <span class="keyword">in</span> DEFAULT_TEMPLATES <span class="keyword">when</span> base.key <span class="keyword">is</span> template.key

          template.image = <span class="keyword">switch</span> template.key
            <span class="keyword">when</span> <span class="string">'PREDEFINED.00001'</span>
              <span class="keyword">if</span> template.image <span class="keyword">is</span> <span class="string">'tmpl_globe'</span> <span class="keyword">then</span> base.image
              <span class="keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="keyword">or</span> <span class="string">''</span>
            <span class="keyword">when</span> <span class="string">'PREDEFINED.00002'</span>
              <span class="keyword">if</span> template.image <span class="keyword">is</span> <span class="string">'tmpl_link'</span> <span class="keyword">then</span> base.image
              <span class="keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="keyword">or</span> <span class="string">''</span>
            <span class="keyword">when</span> <span class="string">'PREDEFINED.00003'</span>
              <span class="keyword">if</span> template.image <span class="keyword">is</span> <span class="string">'tmpl_html'</span> <span class="keyword">then</span> base.image
              <span class="keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="keyword">or</span> <span class="string">''</span>
            <span class="keyword">when</span> <span class="string">'PREDEFINED.00004'</span>
              <span class="keyword">if</span> template.image <span class="keyword">is</span> <span class="string">'tmpl_component'</span> <span class="keyword">then</span> base.image
              <span class="keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="keyword">or</span> <span class="string">''</span>
            <span class="keyword">when</span> <span class="string">'PREDEFINED.00005'</span>
              <span class="keyword">if</span> template.image <span class="keyword">is</span> <span class="string">'tmpl_discussion'</span> <span class="keyword">then</span> base.image
              <span class="keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="keyword">or</span> <span class="string">''</span>
            <span class="keyword">when</span> <span class="string">'PREDEFINED.00006'</span>
              <span class="keyword">if</span> template.image <span class="keyword">is</span> <span class="string">'tmpl_discussion'</span> <span class="keyword">then</span> base.image
              <span class="keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="keyword">or</span> <span class="string">''</span>
            <span class="keyword">when</span> <span class="string">'PREDEFINED.00007'</span>
              <span class="keyword">if</span> template.image <span class="keyword">is</span> <span class="string">'tmpl_note'</span> <span class="keyword">then</span> base.image
              <span class="keyword">else</span> Icon.fromLegacy(template.image)?.name <span class="keyword">or</span> <span class="string">''</span>
            <span class="keyword">else</span> base.image
        <span class="keyword">else</span>
          template.image = Icon.fromLegacy(template.image)?.name <span class="keyword">or</span> <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>Initialize the settings related to the toolbar/browser action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initToolbar</span></span> = -&gt;
  log.trace()

  <span class="keyword">do</span> initToolbar_update

  store.modify <span class="string">'toolbar'</span>, (toolbar) -&gt;
    toolbar.close   ?= <span class="literal">yes</span>
    toolbar.key     ?= <span class="string">'PREDEFINED.00001'</span>
    toolbar.options ?= <span class="literal">yes</span>
    toolbar.popup   ?= <span class="literal">yes</span>

  ext.updateToolbar()</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have been stored previously
by <code>initToolbar</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initToolbar_update</span></span> = -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>Create updater for the <code>toolbar</code> namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updater = <span class="keyword">new</span> store.Updater <span class="string">'toolbar'</span>
  updater.<span class="literal">on</span> <span class="string">'update'</span>, (version) -&gt;
    log.info <span class="string">"Updating toolbar settings for <span class="subst">#{version}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>Define the processes for all required updates to the <code>toolbar</code> namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updater.update <span class="string">'1.0.0'</span>, -&gt;
    store.modify <span class="string">'toolbar'</span>, (toolbar) -&gt;
      toolbar.popup = store.get(<span class="string">'toolbarPopup'</span>) ? <span class="literal">yes</span>
      toolbar.style = store.get(<span class="string">'toolbarFeatureDetails'</span>) ? <span class="literal">no</span>
    store.remove <span class="string">'toolbarFeature'</span>, <span class="string">'toolbarFeatureDetails'</span>, <span class="string">'toolbarFeatureName'</span>, <span class="string">'toolbarPopup'</span>

  updater.update <span class="string">'1.1.0'</span>, -&gt;
    store.modify <span class="string">'toolbar'</span>, (toolbar) -&gt;
      <span class="keyword">delete</span> toolbar.style</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Initialize the settings related to the supported URL Shortener services.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initUrlShorteners</span></span> = -&gt;
  log.trace()

  store.init
    bitly:  {}
    googl:  {}
    yourls: {}

  <span class="keyword">do</span> initUrlShorteners_update

  store.modify <span class="string">'bitly'</span>, (bitly) -&gt;
    bitly.enabled ?= <span class="literal">yes</span>
    bitly.usage   ?= <span class="number">0</span>

  store.modify <span class="string">'googl'</span>, (googl) -&gt;
    googl.enabled ?= <span class="literal">no</span>
    googl.usage   ?= <span class="number">0</span>

  store.modify <span class="string">'yourls'</span>, (yourls) -&gt;
    yourls.authentication ?= <span class="string">''</span>
    yourls.enabled        ?= <span class="literal">no</span>
    yourls.password       ?= <span class="string">''</span>
    yourls.signature      ?= <span class="string">''</span>
    yourls.url            ?= <span class="string">''</span>
    yourls.username       ?= <span class="string">''</span>
    yourls.usage          ?= <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have been stored previously
by <code>initUrlShorteners</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initUrlShorteners_update</span></span> = -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>Create updater for the <code>shorteners</code> namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updater = <span class="keyword">new</span> store.Updater <span class="string">'shorteners'</span>
  updater.<span class="literal">on</span> <span class="string">'update'</span>, (version) -&gt;
    log.info <span class="string">"Updating URL shortener settings for <span class="subst">#{version}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>Define the processes for all required updates to the <code>shorteners</code> namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updater.update <span class="string">'0.1.0.0'</span>, -&gt;
    store.rename <span class="string">'bitlyEnabled'</span>,       <span class="string">'bitly'</span>,         <span class="literal">yes</span>
    store.rename <span class="string">'bitlyXApiKey'</span>,       <span class="string">'bitlyApiKey'</span>,   <span class="string">''</span>
    store.rename <span class="string">'bitlyXLogin'</span>,        <span class="string">'bitlyUsername'</span>, <span class="string">''</span>
    store.rename <span class="string">'googleEnabled'</span>,      <span class="string">'googl'</span>,         <span class="literal">no</span>
    store.rename <span class="string">'googleOAuthEnabled'</span>, <span class="string">'googlOAuth'</span>,    <span class="literal">yes</span>

  updater.update <span class="string">'1.0.0'</span>, -&gt;
    bitly = store.get <span class="string">'bitly'</span>
    store.set <span class="string">'bitly'</span>,
      apiKey:    store.get(<span class="string">'bitlyApiKey'</span>)   ? <span class="string">''</span>
      enabled:   <span class="keyword">if</span> _.isBoolean bitly <span class="keyword">then</span> bitly <span class="keyword">else</span> <span class="literal">yes</span>
      username:  store.get(<span class="string">'bitlyUsername'</span>) ? <span class="string">''</span>
    store.remove <span class="string">'bitlyApiKey'</span>, <span class="string">'bitlyUsername'</span>

    googl = store.get <span class="string">'googl'</span>
    store.set <span class="string">'googl'</span>,
      enabled: <span class="keyword">if</span> _.isBoolean googl <span class="keyword">then</span> googl <span class="keyword">else</span> <span class="literal">no</span>
    store.remove <span class="string">'googlOAuth'</span>

    yourls = store.get <span class="string">'yourls'</span>
    store.set <span class="string">'yourls'</span>,
      enabled:   <span class="keyword">if</span> _.isBoolean yourls <span class="keyword">then</span> yourls <span class="keyword">else</span> <span class="literal">no</span>
      password:  store.get(<span class="string">'yourlsPassword'</span>)  ? <span class="string">''</span>
      signature: store.get(<span class="string">'yourlsSignature'</span>) ? <span class="string">''</span>
      url:       store.get(<span class="string">'yourlsUrl'</span>)       ? <span class="string">''</span>
      username:  store.get(<span class="string">'yourlsUsername'</span>)  ? <span class="string">''</span>
    store.remove <span class="string">'yourlsPassword'</span>, <span class="string">'yourlsSignature'</span>, <span class="string">'yourlsUrl'</span>, <span class="string">'yourlsUsername'</span>

  updater.update <span class="string">'1.0.1'</span>, -&gt;
    store.modify <span class="string">'bitly'</span>, (bitly) -&gt;
      <span class="keyword">delete</span> bitly.apiKey
      <span class="keyword">delete</span> bitly.username

    store.modify <span class="string">'yourls'</span>, (yourls) -&gt;
      yourls.authentication = <span class="keyword">if</span> yourls.signature <span class="keyword">then</span> <span class="string">'advanced'</span>
      <span class="keyword">else</span> <span class="keyword">if</span> yourls.password <span class="keyword">and</span> yourls.username <span class="keyword">then</span> <span class="string">'basic'</span>
      <span class="keyword">else</span> <span class="string">''</span>

    store.remove store.search(<span class="regexp">/^oauth_token.*/</span>)...

  updater.update <span class="string">'1.2.3'</span>, -&gt;
    store.modify <span class="string">'yourls'</span>, (yourls) -&gt;
      <span class="keyword">delete</span> yourls.Password
      <span class="keyword">delete</span> yourls.Signature
      <span class="keyword">delete</span> yourls.Url
      <span class="keyword">delete</span> yourls.Username</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <h2>URL shortener functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>Call the active URL shortener service for each URL in <code>map</code> in order to obtain their
corresponding short URLs.<br><code>callback</code> will be called with the result once all URLs have been shortened or an error is
encountered.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">callUrlShortener</span></span> = (map, callback) -&gt;
  log.trace()

  service  = <span class="keyword">do</span> getActiveUrlShortener
  endpoint = service.url()
  oauth    = <span class="literal">no</span>
  title    = service.title</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Ensure the service URL exists in case it is user-defined (e.g. YOURLS).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> callback <span class="keyword">new</span> AppError <span class="string">'shortener_config_error'</span>, title <span class="keyword">unless</span> endpoint

  tasks = []
  _.each map, (url, placeholder) -&gt;
    oauth = !!service.oauth?.hasAccessToken()

    tasks.push (done) -&gt;
      async.series [
        (done) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Ensure the OAuth adapter has been authorized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> oauth
            service.oauth.authorize -&gt;
              <span class="keyword">do</span> done
          <span class="keyword">else</span>
            <span class="keyword">do</span> done

        (done) -&gt;
          params    = service.getParameters url
          endpoint += <span class="string">"?<span class="subst">#{$.param params}</span>"</span> <span class="keyword">if</span> params?</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Build the HTTP asynchronous request for the URL shortener service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          xhr = <span class="keyword">new</span> XMLHttpRequest()
          xhr.open service.method, endpoint, <span class="literal">yes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>Allow service to populate request headers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">for</span> own header, value <span class="keyword">of</span> service.getHeaders() ? {}
            xhr.setRequestHeader header, value

          xhr.<span class="function"><span class="title">onreadystatechange</span></span> = -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>Wait for the response and let the service handle it before passing the result back.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> xhr.readyState <span class="keyword">is</span> <span class="number">4</span>
              <span class="keyword">if</span> xhr.status <span class="keyword">is</span> <span class="number">200</span>
                map[placeholder] = service.output xhr.responseText
                <span class="keyword">do</span> done
              <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>Something went wrong so let&#39;s tell the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                done <span class="keyword">new</span> AppError <span class="string">'shortener_detailed_error'</span>, title, url</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>Finally, send the HTTP request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          xhr.send service.input url

      ], done
  async.series tasks, (err) -&gt;
    <span class="keyword">if</span> err
      err.message <span class="keyword">or</span>= i18n.get <span class="string">'shortener_error'</span>, service.title
      callback err
    <span class="keyword">else</span>
      callback <span class="literal">null</span>, {oauth, service}</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>Retrieve the active URL shortener service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getActiveUrlShortener</span></span> = -&gt;
  log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>Attempt to lookup enabled URL shortener service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  shortener = _.find SHORTENERS, (shortener) -&gt;
    shortener.isEnabled()

  <span class="keyword">unless</span> shortener?</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>Should never reach here but we&#39;ll return bit.ly service by default after ensuring it&#39;s the
active URL shortener service from now on to save some time in the future.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    store.modify <span class="string">'bitly'</span>, (bitly) -&gt;
      bitly.enabled = <span class="literal">yes</span>
    shortener = <span class="keyword">do</span> getActiveUrlShortener

  log.debug <span class="string">"Getting details for <span class="subst">#{shortener.title}</span> URL shortener"</span>

  shortener</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <h2>Background page setup</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
ext = window.ext = <span class="keyword">new</span> <span class="class"><span class="keyword">class</span> <span class="title">Extension</span> <span class="keyword">extends</span> <span class="title">utils</span>.<span class="title">Class</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <h2>Public constants</h2>

            </div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>String representation of the keyboard modifiers listened to by Template on Windows/Linux
platforms.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  SHORTCUT_MODIFIERS: <span class="string">'Ctrl+Alt+'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>String representation of the keyboard modifiers listened to by Template on Mac platforms.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  SHORTCUT_MAC_MODIFIERS: <span class="string">'&amp;#8679;&amp;#8997;'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <h2>Public variables</h2>

            </div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Configuration data loaded at runtime.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  config: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>Information specifying what should be displaying in the notification.<br>This should be reset after every copy request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  notification:
    description:      <span class="string">''</span>
    descriptionStyle: <span class="string">''</span>
    html:             <span class="string">''</span>
    icon:             utils.url <span class="string">'../images/icon_48.png'</span>
    iconStyle:        <span class="string">''</span>
    title:            <span class="string">''</span>
    titleStyle:       <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>Reference to supported URL shortener services.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  shorteners: SHORTENERS</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>Local copy of templates being used, ordered to match that specified by the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  templates: []</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>Pre-prepared HTML for the popup to be populated using.<br>This should be updated whenever templates are changed/updated in any way as this is generated
to improve performance and load times of the popup frame.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  templatesHtml: <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>Current version of Template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  version: <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <h2>Public functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>Add <code>str</code> to the system clipboard.<br>All successful copy requests should, at some point, call this function.<br>If <code>str</code> is empty the contents of the system clipboard will not change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  copy: (str, hidden) -&gt;
    log.trace()

    sandbox = $(<span class="string">'#sandbox'</span>).val(str).trigger <span class="string">'select'</span>
    document.execCommand <span class="string">'copy'</span>
    log.debug <span class="string">'Copied the following string...'</span>, str
    sandbox.val <span class="string">''</span>

    <span class="keyword">do</span> showNotification <span class="keyword">unless</span> hidden</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>Attempt to retrieve the key of the template with the specified <code>name</code>.<br>Since only the names of predefined templates are known, return a newly generated key if it does
not match any of their names.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getKeyForName: (name, generate = <span class="literal">yes</span>) -&gt;
    log.trace()

    key = <span class="keyword">switch</span> name
      <span class="keyword">when</span> <span class="string">'_url'</span>      <span class="keyword">then</span> <span class="string">'PREDEFINED.00001'</span>
      <span class="keyword">when</span> <span class="string">'_short'</span>    <span class="keyword">then</span> <span class="string">'PREDEFINED.00002'</span>
      <span class="keyword">when</span> <span class="string">'_anchor'</span>   <span class="keyword">then</span> <span class="string">'PREDEFINED.00003'</span>
      <span class="keyword">when</span> <span class="string">'_encoded'</span>  <span class="keyword">then</span> <span class="string">'PREDEFINED.00004'</span>
      <span class="keyword">when</span> <span class="string">'_bbcode'</span>   <span class="keyword">then</span> <span class="string">'PREDEFINED.00005'</span>
      <span class="keyword">when</span> <span class="string">'_markdown'</span> <span class="keyword">then</span> <span class="string">'PREDEFINED.00006'</span>
      <span class="keyword">else</span> utils.keyGen() <span class="keyword">if</span> generate

    log.debug <span class="string">"Associating <span class="subst">#{key}</span> key with <span class="subst">#{name}</span> template"</span>

    key</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>Initialize the background page.<br>This will involve initializing the settings and adding the message listeners.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init: -&gt;
    log.trace()

    log.info <span class="string">'Initializing extension controller'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>Add support for analytics if the user hasn&#39;t opted out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    analytics.add() <span class="keyword">if</span> store.get <span class="string">'analytics'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>Load the configuration data from the file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.getJSON utils.url(<span class="string">'configuration.json'</span>), (data) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>Store the configuration data and then ensure it&#39;s data is in the most usable format.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@config</span> = data
      <span class="keyword">do</span> buildConfig</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>It&#39;s nice knowing what version is running.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      {<span class="property">@version</span>} = chrome.runtime.getManifest()</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>Initiate OAuth for each of the applicable URL shortener services.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      shortener.oauth = shortener.oauth?() <span class="keyword">for</span> shortener <span class="keyword">in</span> SHORTENERS</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>Begin initialization.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      store.init
        links:         {}
        markdown:      {}
        menu:          {}
        notifications: {}
        shortcuts:     {}
        stats:         {}
        templates:     []
        toolbar:       {}

      <span class="keyword">do</span> init_update

      store.modify <span class="string">'links'</span>, (links) -&gt;
        links.target ?= <span class="literal">off</span>
        links.title  ?= <span class="literal">off</span>

      store.modify <span class="string">'markdown'</span>, (markdown) -&gt;
        markdown.inline ?= <span class="literal">no</span>

      store.modify <span class="string">'menu'</span>, (menu) -&gt;
        menu.enabled ?= <span class="literal">yes</span>
        menu.options ?= <span class="literal">yes</span>
        menu.paste   ?= <span class="literal">no</span>

      store.modify <span class="string">'notifications'</span>, (notifications) -&gt;
        notifications.duration ?= <span class="number">3000</span>
        notifications.enabled  ?= <span class="literal">yes</span>

      store.modify <span class="string">'shortcuts'</span>, (shortcuts) -&gt;
        shortcuts.enabled ?= <span class="literal">yes</span>
        shortcuts.paste   ?= <span class="literal">no</span>

      <span class="keyword">do</span> initTemplates
      <span class="keyword">do</span> initToolbar
      <span class="keyword">do</span> initStatistics
      <span class="keyword">do</span> initUrlShorteners</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Add listener for toolbar/browser action clicks.<br>This listener will be ignored whenever the popup is enabled.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.browserAction.onClicked.addListener (tab) -&gt;
        onMessage
          data: key: store.get <span class="string">'toolbar.key'</span>
          type: <span class="string">'toolbar'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>Add listeners for internal and external messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.extension.onMessage.addListener onMessage
      chrome.extension.onMessageExternal.addListener onMessageExternal</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>Derive the browser and OS information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      browser.version = <span class="keyword">do</span> getBrowserVersion
      operatingSystem = <span class="keyword">do</span> getOperatingSystem
      analytics.track <span class="string">'Installs'</span>, <span class="string">'New'</span>, <span class="property">@version</span>, Number isProductionBuild <span class="keyword">if</span> isNewInstall</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>Execute content scripts now that we know the version.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">do</span> executeScriptsInExistingWindows</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>Determine whether or not <code>os</code> matches the user&#39;s operating system.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isThisPlatform: (os) -&gt;
    log.trace()

    <span class="regexp">/// <span class="comment">#{os} ///i.test navigator.platform</span></pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>Retrieve the correct string representation of the keyboard modifiers for the user&#39;s operating
system.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  modifiers: -&gt;
    log.trace()

    <span class="keyword">if</span> <span class="property">@isThisPlatform</span> <span class="string">'mac'</span> <span class="keyword">then</span> <span class="property">@SHORTCUT_MAC_MODIFIERS</span> <span class="keyword">else</span> <span class="property">@SHORTCUT_MODIFIERS</span></pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>Attempt to retrieve the contents of the system clipboard as a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  paste: -&gt;
    log.trace()

    result  = <span class="string">''</span>
    sandbox = $(<span class="string">'#sandbox'</span>).val(<span class="string">''</span>).trigger <span class="string">'select'</span>
    result  = sandbox.val() <span class="keyword">if</span> document.execCommand <span class="string">'paste'</span>
    log.debug <span class="string">'Pasted the following string...'</span>, result
    sandbox.val <span class="string">''</span>

    result</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>Reset the notification information associated with the current copy request.<br>This should be called when a copy request is completed regardless of its outcome.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: -&gt;
    log.trace()

    <span class="property">@notification</span> =
      description:      <span class="string">''</span>
      descriptionStyle: <span class="string">''</span>
      html:             <span class="string">''</span>
      icon:             utils.url <span class="string">'../images/icon_48.png'</span>
      iconStyle:        <span class="string">''</span>
      title:            <span class="string">''</span>
      titleStyle:       <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>Update the context menu items to reflect the currently enabled templates.<br>If the context menu option has been disabled by the user, just remove all of the existing menu
items.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updateContextMenu: -&gt;
    log.trace()</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>Ensure that any previously added context menu items are removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    chrome.contextMenus.removeAll =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>Called whenever a template menu item is clicked.<br>Message self, passing along the available information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="title">onMenuClick</span></span> = (info, tab) -&gt;
        onMessage data: info, type: <span class="string">'menu'</span>

      menu = store.get <span class="string">'menu'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>Stop now if the context menu is disabled.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="keyword">unless</span> menu.enabled</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>Create and add the top-level Template menu.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      parentId = chrome.contextMenus.create
        contexts: [<span class="string">'all'</span>]
        title:    i18n.get <span class="string">'name'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>Create and add a sub-menu item for each enabled template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> template <span class="keyword">in</span> <span class="property">@templates</span> <span class="keyword">when</span> template.enabled
        notEmpty = <span class="literal">yes</span>
        menuId   = chrome.contextMenus.create
          contexts: [<span class="string">'all'</span>]
          onclick:  onMenuClick
          parentId: parentId
          title:    template.title
        template.menuId = menuId</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>Indicate that no templates have been enabled.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">unless</span> notEmpty
        chrome.contextMenus.create
          contexts: [<span class="string">'all'</span>]
          parentId: parentId
          title:    i18n.get <span class="string">'empty'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>Add an item to open the options page if the user doesn&#39;t mind.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> menu.options
        chrome.contextMenus.create
          contexts: [<span class="string">'all'</span>]
          parentId: parentId
          type:     <span class="string">'separator'</span>

        chrome.contextMenus.create
          contexts: [<span class="string">'all'</span>]
          onclick:  (info, tab) -&gt;
            onMessage type: <span class="string">'options'</span>
          parentId: parentId
          title:    i18n.get <span class="string">'options'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>Update the local list of templates to reflect those persisted.<br>It is very important that this is called whenever templates may have been changed in order to
prepare the popup HTML and optimize performance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updateTemplates: -&gt;
    log.trace()

    <span class="property">@templates</span> = _.sortBy store.get(<span class="string">'templates'</span>), <span class="string">'index'</span>

    <span class="keyword">do</span> buildPopup
    <span class="keyword">do</span> <span class="property">@updateContextMenu</span>
    <span class="keyword">do</span> updateStatistics
    <span class="keyword">do</span> updateHotkeys</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>Update the toolbar/browser action depending on the current settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updateToolbar: -&gt;
    log.trace()

    key      = store.get <span class="string">'toolbar.key'</span>
    template = getTemplateWithKey key <span class="keyword">if</span> key

    <span class="keyword">do</span> buildPopup

    <span class="keyword">if</span> <span class="keyword">not</span> template <span class="keyword">or</span> store.get <span class="string">'toolbar.popup'</span>
      log.info <span class="string">'Configuring toolbar to display popup'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>Show the popup when the browser action is clicked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.browserAction.setPopup popup: <span class="string">'pages/popup.html'</span>
    <span class="keyword">else</span>
      log.info <span class="string">'Configuring toolbar to activate specified template'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>Disable the popup, effectively enabling the listener for <code>chrome.browserAction.onClicked</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chrome.browserAction.setPopup popup: <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <h2>Public classes</h2>

            </div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p><code>Icon</code> provides common functionality for using icons throughout the extension.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ext.Icon = <span class="class"><span class="keyword">class</span> <span class="title">Icon</span> <span class="keyword">extends</span> <span class="title">utils</span>.<span class="title">Class</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>Create a new instance of <code>Icon</code> with the specified <code>name</code>.<br>An appropriate localized message and CSS style is also derived.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@name</span>) -&gt;
    <span class="property">@message</span> = i18n.get <span class="string">"icon_<span class="subst">#{name?.replace(/-/g, '_') <span class="keyword">or</span> 'none'}</span>"</span>
    <span class="property">@style</span>   = <span class="string">"icon-<span class="subst">#{name <span class="keyword">or</span> ''}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>Determine whether an <code>Icon</code> with the given <code>name</code> exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Icon.<span class="function"><span class="title">exists</span></span> = (name) -&gt;
  Icon.get(name)?</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>Retrieve the <code>Icon</code> with the given <code>name</code>.<br><code>safe</code> can be used to ensure that an <code>Icon</code> is always returned, although this will be <em>empty</em> (no
name) if none had a matching <code>name</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Icon.<span class="function"><span class="title">get</span></span> = (name, safe) -&gt;
  icon = _.findWhere ext.config.icons.current, {name}

  <span class="keyword">if</span> <span class="keyword">not</span> icon? <span class="keyword">and</span> safe <span class="keyword">then</span> <span class="keyword">new</span> Icon() <span class="keyword">else</span> icon</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>Attempt to retrieve the replacement for the legacy icon with the given <code>name</code>.<br>If <code>name</code> is a number it will be treated as an index of the legacy icon; otherwise a simple
lookup is performed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Icon.<span class="function"><span class="title">fromLegacy</span></span> = (name) -&gt;
  legacy = <span class="keyword">switch</span> <span class="keyword">typeof</span> name
    <span class="keyword">when</span> <span class="string">'number'</span> <span class="keyword">then</span> ext.config.icons.legacy[name]
    <span class="keyword">when</span> <span class="string">'string'</span> <span class="keyword">then</span> _.findWhere ext.config.icons.legacy, {name}

  <span class="keyword">if</span> legacy <span class="keyword">then</span> Icon.get legacy.icon</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>Initialize <code>ext</code> when the DOM is ready.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>utils.ready -&gt; ext.init()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
