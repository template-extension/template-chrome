<!DOCTYPE html>

<html>
<head>
  <title>content.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="analytics.html">
                analytics.coffee
              </a>
            
              
              <a class="source" href="background.html">
                background.coffee
              </a>
            
              
              <a class="source" href="content.html">
                content.coffee
              </a>
            
              
              <a class="source" href="i18n.html">
                i18n.coffee
              </a>
            
              
              <a class="source" href="install.html">
                install.coffee
              </a>
            
              
              <a class="source" href="log.html">
                log.coffee
              </a>
            
              
              <a class="source" href="notification.html">
                notification.coffee
              </a>
            
              
              <a class="source" href="options.html">
                options.coffee
              </a>
            
              
              <a class="source" href="popup.html">
                popup.coffee
              </a>
            
              
              <a class="source" href="store.html">
                store.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>content.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><a href="http://neocotic.com/template">Template</a><br>(c) 2013 Alasdair Mercer<br>Freely distributable under the MIT license.<br>For all details and documentation:<br><a href="http://neocotic.com/template">http://neocotic.com/template</a></p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Private variables</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Backups of relevant elements, each related to individual requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>elementBackups = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Details of the last relevant elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>elements       =
  field: <span class="literal">null</span>
  link:  <span class="literal">null</span>
  other: <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>List of shortcuts used by enabled templates.<br>This list should be updated after any templates have been.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>hotkeys        = []</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2>Helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Extract the value the specified <code>property</code> from all elements of <code>array</code>.<br>If an element does not have a valid <code>property</code> or its value has already been recorded it should
be ignored from the results.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">extractAll</span></span> = (array, property) -&gt;
  results = []
  <span class="keyword">for</span> element <span class="keyword">in</span> array <span class="keyword">when</span> element[property]?
    results.push element[property] <span class="keyword">if</span> element[property] <span class="keyword">not</span> <span class="keyword">in</span> results
  results</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Extract the relevant content of <code>node</code> as is required by <code>info</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getContent</span></span> = (info, node) -&gt;
  <span class="keyword">return</span> <span class="string">''</span> <span class="keyword">unless</span> node

  <span class="keyword">if</span> info?.convertTo <span class="keyword">in</span> [<span class="string">'html'</span>, <span class="string">'markdown'</span>] <span class="keyword">then</span> node.innerHTML
  <span class="keyword">else</span> node.textContent</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Attempt to derive the most relevant anchor element from those stored under the <code>id</code> provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getLink</span></span> = (id, url) -&gt;
  <span class="keyword">return</span> <span class="keyword">unless</span> elementBackups[id]?

  <span class="keyword">if</span> elementBackups[id].link?.href <span class="keyword">is</span> url <span class="keyword">then</span> elementBackups[id].link
  <span class="keyword">else</span> parentLink elementBackups[id].other</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Attempt to extract the contents of the meta element with the specified <code>name</code>.<br>If <code>csv</code> is enabled, separate the contents by commas and return each unique value in an array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getMeta</span></span> = (name, csv) -&gt;
  content = document.querySelector(<span class="string">"meta[name='<span class="subst">#{name}</span>']"</span>)?.content?.trim()

  <span class="keyword">if</span> csv <span class="keyword">and</span> content?
    results = []
    <span class="keyword">for</span> value <span class="keyword">in</span> content.split <span class="regexp">/\s*,\s*/</span> <span class="keyword">when</span> value.length
      results.push value <span class="keyword">if</span> value <span class="keyword">not</span> <span class="keyword">in</span> results
    results
  <span class="keyword">else</span>
    content</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Determine whether or not <code>node</code> is editable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">isEditable</span></span> = (node) -&gt;
  node? <span class="keyword">and</span> <span class="keyword">not</span> node.disabled <span class="keyword">and</span> <span class="keyword">not</span> node.readOnly</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Traverse the parents of <code>node</code> in search of the first anchor element, if any.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">parentLink</span></span> = (node) -&gt;
  <span class="keyword">return</span> <span class="keyword">unless</span> node?

  <span class="keyword">if</span> node.nodeName <span class="keyword">is</span> <span class="string">'A'</span> <span class="keyword">then</span> node <span class="keyword">else</span> parentLink node.parentNode</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Paste <code>value</code> in to the editable <code>node</code>.<br>This should simulate pasting as much as possible, so the current value of <code>node</code> should be
manipulated in such a way instead of simply replacing it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">paste</span></span> = (node, value) -&gt;
  <span class="keyword">return</span> <span class="keyword">unless</span> node? <span class="keyword">or</span> value

  str  = node.value.substr <span class="number">0</span>, node.selectionStart
  str += value
  str += node.value.substr node.selectionEnd, node.value.length

  node.value = str</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2>Functionality</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Wrap the function functionality in a message for Template&#39;s extension ID and current version so
that it can be used to detect previous injections.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>chrome.extension.sendMessage type: <span class="string">'info'</span>, (data) -&gt;
  hotkeys = data.hotkeys
  isMac   = navigator.userAgent.toLowerCase().indexOf(<span class="string">'mac'</span>) <span class="keyword">isnt</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Only add the listeners if a previous injection isn&#39;t detected for version
of Template that is currently running.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> <span class="keyword">if</span> document.body.getAttribute(data.id) <span class="keyword">is</span> data.version
  document.body.setAttribute data.id, data.version</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Record relevant links and input fields when using the right-click menu.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addEventListener <span class="string">'contextmenu'</span>, (e) -&gt;
    <span class="keyword">switch</span> e.target.nodeName
      <span class="keyword">when</span> <span class="string">'A'</span> <span class="keyword">then</span> elements.link = e.target
      <span class="keyword">when</span> <span class="string">'INPUT'</span>, <span class="string">'TEXTAREA'</span> <span class="keyword">then</span> elements.field = e.target
      <span class="keyword">else</span> elements.other = e.target</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Add a listener for extension keyboard shortcuts in to the page context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addEventListener <span class="string">'keydown'</span>, (e) -&gt;
    <span class="keyword">if</span> (<span class="keyword">not</span> isMac <span class="keyword">and</span> e.ctrlKey <span class="keyword">and</span> e.altKey) <span class="keyword">or</span> (isMac <span class="keyword">and</span> e.shiftKey <span class="keyword">and</span> e.altKey)
      key = String.fromCharCode(e.keyCode).toUpperCase()

      <span class="keyword">if</span> key <span class="keyword">in</span> hotkeys
        elements.field = <span class="keyword">if</span> e.target.nodeName <span class="keyword">in</span> [<span class="string">'INPUT'</span>, <span class="string">'TEXTAREA'</span>] <span class="keyword">then</span> e.target <span class="keyword">else</span> <span class="literal">null</span>

        chrome.extension.sendMessage
          data: key: key
          type: <span class="string">'shortcut'</span>
        e.preventDefault()</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Add a listener to provide the background page with information that is extracted from the DOM
or perform auto-paste functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  chrome.extension.onMessage.addListener (message, sender, sendResponse) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Safely handle callback functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">callback</span></span> = (args...) -&gt;
      <span class="keyword">if</span> <span class="keyword">typeof</span> sendResponse <span class="keyword">is</span> <span class="string">'function'</span>
        sendResponse args...
        <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Ensure local hotkeys are up-to-date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> message.hotkeys?
      hotkeys = message.hotkeys
      <span class="keyword">return</span> <span class="keyword">do</span> callback</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Retrieve the contents of all selected elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> message.selectors?
      <span class="keyword">for</span> own key, info <span class="keyword">of</span> message.selectors
        <span class="keyword">if</span> info.all
          nodes  = document.querySelectorAll info.selector
          result = []
          <span class="keyword">if</span> nodes
            result.push getContent info, node <span class="keyword">for</span> node <span class="keyword">in</span> nodes <span class="keyword">when</span> node
        <span class="keyword">else</span>
          node   = document.querySelector info.selector
          result = getContent info, node <span class="keyword">if</span> node
        info.result = result
      <span class="keyword">return</span> callback selectors: message.selectors</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Message identifier is required past this point.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="keyword">do</span> callback <span class="keyword">unless</span> message.id?</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Paste the message contents into the targeted field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> message.type <span class="keyword">is</span> <span class="string">'paste'</span>
      <span class="keyword">if</span> message.contents? <span class="keyword">and</span> isEditable elementBackups[message.id]?.field
        paste elementBackups[message.id].field, message.contents</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Backups no longer required so might as well clean up a bit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">delete</span> elementBackups[message.id]
      <span class="keyword">return</span> <span class="keyword">do</span> callback</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Create a backup of the relevant elements for this request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    elementBackups[message.id] =
      field: <span class="keyword">if</span> message.editable <span class="keyword">or</span> message.shortcut <span class="keyword">then</span> elements.field
      link:  <span class="keyword">if</span> message.link <span class="keyword">then</span> elements.link
      other: <span class="keyword">if</span> message.link <span class="keyword">then</span> elements.other</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Extract any user-selected contents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    selection = <span class="keyword">do</span> getSelection
    <span class="keyword">unless</span> selection.isCollapsed
      contents = selection.getRangeAt(<span class="number">0</span>).cloneContents()
      <span class="keyword">if</span> contents
        container = document.createElement <span class="string">'div'</span>
        container.appendChild contents</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Convert relative addresses to absolute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        href.href = href.href <span class="keyword">for</span> href <span class="keyword">in</span> container.querySelectorAll <span class="string">'[href]'</span>
        src.src   = src.src   <span class="keyword">for</span> src  <span class="keyword">in</span> container.querySelectorAll <span class="string">'[src]'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Capture addresses for links and images.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        images = extractAll container.querySelectorAll(<span class="string">'img[src]'</span>), <span class="string">'src'</span>
        links  = extractAll container.querySelectorAll(<span class="string">'a[href]'</span>),  <span class="string">'href'</span>

    link = getLink message.id, message.url</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Build response with values derived from the DOM.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    callback
      author:         getMeta <span class="string">'author'</span>
      characterSet:   document.characterSet
      description:    getMeta <span class="string">'description'</span>
      images:         extractAll document.images, <span class="string">'src'</span>
      keywords:       getMeta <span class="string">'keywords'</span>, <span class="literal">yes</span>
      lastModified:   document.lastModified
      linkHTML:       link?.innerHTML
      linkText:       link?.textContent
      links:          extractAll document.links, <span class="string">'href'</span>
      pageHeight:     innerHeight
      pageWidth:      innerWidth
      referrer:       document.referrer
      scripts:        extractAll document.scripts, <span class="string">'src'</span>
      selectedImages: images
      selectedLinks:  links
      selection:      selection.toString()
      selectionHTML:  container?.innerHTML
      styleSheets:    extractAll document.styleSheets, <span class="string">'href'</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
